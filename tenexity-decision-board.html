<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenexity Decision Board</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --background: oklch(0.9755 0.0045 258.3245);
            --foreground: oklch(0.2558 0.0433 268.0662);
            --card: oklch(0.9341 0.0132 251.5628);
            --card-foreground: oklch(0.2558 0.0433 268.0662);
            --primary: oklch(0.4815 0.1178 263.3758);
            --primary-foreground: oklch(0.9856 0.0278 98.0540);
            --secondary: oklch(0.8567 0.1164 81.0092);
            --secondary-foreground: oklch(0.2558 0.0433 268.0662);
            --muted: oklch(0.9202 0.0080 106.5563);
            --muted-foreground: oklch(0.4815 0.1178 263.3758);
            --accent: oklch(0.6896 0.0714 234.0387);
            --accent-foreground: oklch(0.9856 0.0278 98.0540);
            --destructive: oklch(0.5280 0.1200 357.1130);
            --destructive-foreground: oklch(0.9856 0.0278 98.0540);
            --border: oklch(0.7791 0.0156 251.1926);
            --input: oklch(0.6896 0.0714 234.0387);
            --ring: oklch(0.8567 0.1164 81.0092);
            --sidebar: oklch(0.9341 0.0132 251.5628);
            --sidebar-foreground: oklch(0.2558 0.0433 268.0662);
            --radius: 0.625rem;
            --shadow-sm: 0 1px 3px 0px hsl(0 0% 0% / 0.08);
            --shadow: 0 2px 8px 0px hsl(0 0% 0% / 0.08);
            --shadow-md: 0 4px 12px 0px hsl(0 0% 0% / 0.10);
            --shadow-lg: 0 8px 24px 0px hsl(0 0% 0% / 0.12);
        }

        * {
            font-family: 'Libre Baskerville', Georgia, serif;
        }

        body {
            background: var(--background);
            color: var(--foreground);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .card-hover:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
        }

        .text-muted {
            color: var(--muted-foreground);
        }

        .bg-muted {
            background: var(--muted);
        }

        .border-themed {
            border-color: var(--border);
        }

        @keyframes pulse-recording {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .recording-pulse {
            animation: pulse-recording 1.5s ease-in-out infinite;
        }

        .audio-waveform {
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* ============================== */
        /* MOBILE RESPONSIVE STYLES */
        /* ============================== */

        /* Tablet breakpoint */
        @media (max-width: 1024px) {
            .desktop-only {
                display: none !important;
            }

            .sidebar-panel {
                width: 280px !important;
            }
        }

        /* Mobile breakpoint */
        @media (max-width: 640px) {
            .desktop-only {
                display: none !important;
            }

            .mobile-only {
                display: flex !important;
            }

            .mobile-hidden {
                display: none !important;
            }

            /* Header adjustments */
            .mobile-header {
                padding: 12px 16px !important;
            }

            .mobile-header h1 {
                font-size: 1rem !important;
            }

            /* Main content */
            .mobile-container {
                padding: 0 !important;
            }

            /* Sidebar becomes full screen */
            .sidebar-panel {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 60px !important;
                width: 100% !important;
                z-index: 50 !important;
                border-radius: 0 !important;
            }

            /* Topic detail becomes full screen */
            .detail-panel {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 60px !important;
                width: 100% !important;
                z-index: 50 !important;
                overflow-y: auto !important;
                background: var(--background) !important;
            }

            /* Cards on mobile */
            .card {
                border-radius: 0 !important;
                border-left: none !important;
                border-right: none !important;
            }

            /* Form inputs */
            .mobile-stack {
                flex-direction: column !important;
            }

            .mobile-stack>* {
                width: 100% !important;
            }

            /* Touch-friendly sizing */
            button,
            select,
            input {
                min-height: 44px !important;
            }

            /* Contribution form adjustments */
            .contribution-form {
                flex-direction: column !important;
                gap: 12px !important;
            }
        }

        /* Bottom Navigation Styles */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: none;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        @media (max-width: 640px) {
            .bottom-nav {
                display: flex;
            }

            .top-tabs {
                display: none !important;
            }

            /* Add padding to body for bottom nav */
            body {
                padding-bottom: 60px;
            }
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            color: var(--muted-foreground);
            transition: all 0.2s;
            border-radius: 8px;
        }

        .bottom-nav-item.active {
            color: var(--primary);
            background: var(--muted);
        }

        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
        }

        .bottom-nav-item span {
            font-size: 10px;
            margin-top: 2px;
            font-weight: 500;
        }

        /* Mobile back button */
        .mobile-back-btn {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            color: var(--primary);
            font-weight: 500;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        @media (max-width: 640px) {
            .mobile-back-btn {
                display: flex;
            }
        }

        /* FAB button for mobile */
        .fab-button {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--primary-foreground);
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            z-index: 99;
            transition: transform 0.2s;
        }

        .fab-button:hover {
            transform: scale(1.05);
        }

        @media (max-width: 640px) {
            .fab-button {
                display: flex;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // ============================================
        // TENEXITY LOGO COMPONENT
        // ============================================
        const TenexityLogo = ({ size = 40, className = "" }) => (
            <img
                src="logo.png"
                alt="Tenexity Logo"
                style={{ width: size, height: size, objectFit: 'contain' }}
                className={className}
            />
        );

        const TenexityLogoFull = ({ height = 32 }) => (
            <div className="flex items-center gap-1 justify-center">
                <TenexityLogo size={height * 1.5} />
            </div>
        );

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // IMPORTANT: Replace these with your Supabase project credentials
        // Get these from: Supabase Dashboard > Project Settings > API
        const SUPABASE_URL = 'https://nilgqhewhxyvgufevsuw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbGdxaGV3aHh5dmd1ZmV2c3V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNjk2MjQsImV4cCI6MjA4Mzg0NTYyNH0.glEw2hN7lVjlUyl3GdIP1D58oxl83moCKXnJn8zlKQo';

        // Initialize Supabase (only if config is set)
        let supabaseClient = null;
        const isSupabaseConfigured = SUPABASE_URL !== 'YOUR_SUPABASE_URL';

        // Debug: Check if Supabase SDK loaded
        console.log('Supabase SDK loaded:', !!window.supabase);
        console.log('Supabase configured:', isSupabaseConfigured);

        if (isSupabaseConfigured && window.supabase) {
            try {
                // The UMD build exposes createClient directly on window.supabase
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        storage: window.sessionStorage,
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true
                    }
                });
                console.log('Supabase client created successfully');
            } catch (err) {
                console.error('Error creating Supabase client:', err);
            }
        } else if (isSupabaseConfigured && !window.supabase) {
            console.error('Supabase SDK not loaded! window.supabase is undefined');
        }

        // ============================================
        // CONTEXTS
        // ============================================
        const AuthContext = createContext(null);
        const BoardContext = createContext(null);
        const TodoContext = createContext(null);

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const generateInviteCode = () => Math.random().toString(36).substr(2, 8).toUpperCase();

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const formatDuration = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        // ============================================
        // AUTH PROVIDER (SUPABASE)
        // ============================================
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [boards, setBoards] = useState([]);
            const [currentBoardId, setCurrentBoardId] = useState(null);
            const [members, setMembers] = useState([]);
            const [invitations, setInvitations] = useState([]);
            const [isDevMode, setIsDevMode] = useState(false);
            const [authError, setAuthError] = useState(null);

            // Load board details (members & invitations) when board changes
            useEffect(() => {
                if (currentBoardId && user) {
                    loadBoardDetails(currentBoardId);
                }
            }, [currentBoardId, user]);

            useEffect(() => {
                console.log('AuthProvider mounted');
                if (!isSupabaseConfigured || !supabaseClient) {
                    console.log('Supabase not configured, stopping loading');
                    setLoading(false);
                    return;
                }

                // Failsafe: Stop loading after 3 seconds
                const timer = setTimeout(() => {
                    if (loading) {
                        console.warn('Auth loading timed out, forcing render');
                        setLoading(false);
                    }
                }, 8000); // Increased to 8s to allow for slower connections

                supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
                    if (session?.user) {
                        setUser(session.user);
                        await loadUserData(session.user);
                    }
                    setLoading(false);
                }).catch(err => {
                    console.error('getSession error:', err);
                    setAuthError(err.message);
                    setLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    if (session?.user) {
                        setUser(session.user);
                        await loadUserData(session.user);
                    } else {
                        setUser(null);
                        setUserProfile(null);
                        setBoards([]);
                        setCurrentBoardId(null);
                        setAuthError(null);
                    }
                    setLoading(false);
                });

                return () => {
                    clearTimeout(timer);
                    subscription.unsubscribe();
                };
            }, []);

            const loadUserData = async (user) => {
                try {
                    setAuthError(null);
                    // Get or create user profile
                    let { data: profile, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();

                    if (error && error.code === 'PGRST116') {
                        // Create profile if missing
                        const { data, error: insertError } = await supabaseClient
                            .from('profiles')
                            .insert({
                                id: user.id,
                                email: user.email,
                                display_name: user.email.split('@')[0],
                                created_at: new Date().toISOString()
                            })
                            .select()
                            .single();
                        if (!insertError) profile = data;
                    } else if (error) {
                        throw error;
                    }

                    if (profile) {
                        setUserProfile({
                            displayName: profile.display_name,
                            email: profile.email,
                            email_notifications: profile.email_notifications
                        });
                    }

                    // Get user's boards
                    const { data: memberData, error: memberError } = await supabaseClient
                        .from('board_members')
                        .select('board_id')
                        .eq('user_id', user.id);

                    if (memberError) throw memberError;

                    if (memberData && memberData.length > 0) {
                        const boardIds = memberData.map(m => m.board_id);
                        const { data: boardsData, error: boardsError } = await supabaseClient
                            .from('boards')
                            .select('*')
                            .in('id', boardIds);

                        if (boardsError) throw boardsError;

                        if (boardsData) {
                            setBoards(boardsData);
                            if (boardsData.length > 0 && !currentBoardId) {
                                setCurrentBoardId(boardsData[0].id);
                            }
                        }
                    } else {
                        setBoards([]);
                        console.log('User has no boards (memberData empty)');
                    }
                } catch (err) {
                    console.error('Error loading user data:', err);
                    setAuthError('Failed to load your data: ' + (err.message || 'Unknown error'));
                } finally {
                    setLoading(false);
                }
            };

            const loadBoardDetails = async (boardId) => {
                if (!supabaseClient) return;
                try {
                    // 1. Get Members
                    const { data: memberData, error: memberError } = await supabaseClient
                        .from('board_members')
                        .select('user_id')
                        .eq('board_id', boardId);

                    if (!memberError && memberData) {
                        const userIds = memberData.map(m => m.user_id);
                        if (userIds.length > 0) {
                            const { data: profiles, error: profileError } = await supabaseClient
                                .from('profiles')
                                .select('*')
                                .in('id', userIds);

                            if (!profileError) setMembers(profiles || []);
                        } else {
                            setMembers([]);
                        }
                    }

                    // 2. Get Invitations

                    const { data: inviteData, error: inviteError } = await supabaseClient
                        .from('invitations')
                        .select('*')
                        .eq('board_id', boardId)
                        .eq('status', 'pending'); // Only pending ones



                    if (inviteError) {
                        console.error('Error fetching invitations:', inviteError);
                    }

                    if (!inviteError) {
                        setInvitations(inviteData || []);
                    }

                } catch (err) {
                    console.error('Error loading board details:', err);
                }
            };

            const sendMagicLink = async (email) => {
                const { error } = await supabaseClient.auth.signInWithOtp({
                    email,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });
                if (error) throw error;
            };

            const signInWithPassword = async (email, password) => {
                const { error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                if (error) throw error;
            };

            const signUp = async (email, password) => {
                const { error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });
                if (error) throw error;
            };

            const resetPassword = async (email) => {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin,
                });
                if (error) throw error;
            };

            const devLogin = () => {
                const devUser = { id: 'dev-user-123', email: 'dev@example.com' };
                setIsDevMode(true);
                setUser(devUser);
                setUserProfile({ displayName: 'Developer', email: 'dev@example.com' });
                const dummyBoard = {
                    id: 'dev-board-123',
                    name: 'Developer Board',
                    owner_id: devUser.id,
                    invite_code: 'DEV123',
                    created_at: new Date().toISOString()
                };
                setBoards([dummyBoard]);
                setCurrentBoardId(dummyBoard.id);
            };

            const signOut = async () => {
                console.log('signOut called');
                // alert('Signing out...'); // Debug alert
                try {
                    if (supabaseClient) {
                        // Race logic: timeout after 1 second if supabase is stuck
                        console.log('Attempting Supabase signOut...');
                        const signOutPromise = supabaseClient.auth.signOut();
                        const timeoutPromise = new Promise(resolve => setTimeout(() => resolve('timeout'), 1000));
                        const result = await Promise.race([signOutPromise, timeoutPromise]);
                        console.log('Supabase signOut result:', result === 'timeout' ? 'Timed out' : 'Completed');
                    }
                } catch (e) {
                    console.error('SignOut error (ignoring to force cleanup):', e);
                } finally {
                    // Nuclear cleanup - clear EVERYTHING
                    console.log('Executing nuclear cleanup');
                    window.sessionStorage.clear();
                    window.localStorage.clear(); // Clear ALL localStorage including API keys

                    // Clear cookies too just in case
                    document.cookie.split(";").forEach((c) => {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });

                    // Clear state
                    setIsDevMode(false);
                    setUser(null);
                    setUserProfile(null);
                    setBoards([]);
                    setCurrentBoardId(null);
                    setAuthError(null);

                    // Force hard redirect to root
                    console.log('Redirecting to root...');
                    window.location.href = window.location.origin + window.location.pathname;
                }
            };

            const updateProfile = async (updates) => {
                console.log('updateProfile called with:', updates);
                if (!user) {
                    console.warn('updateProfile: No user found');
                    throw new Error('No user logged in');
                }

                console.log('Sending profile upsert to Supabase for user:', user.id);
                // Use upsert to handle both insert (if missing) and update
                const { error: upsertError } = await supabaseClient
                    .from('profiles')
                    .upsert({
                        id: user.id,
                        email: user.email,
                        display_name: updates.displayName,
                        updated_at: new Date().toISOString(),
                        ...(updates.email_notifications !== undefined && { email_notifications: updates.email_notifications })
                    }, { onConflict: 'id' });

                console.log('Supabase upsert response - error:', upsertError);

                if (upsertError) throw upsertError;
                setUserProfile({ ...userProfile, ...updates });
            };

            const createBoard = async (name) => {
                const inviteCode = generateInviteCode();
                const { data: board, error: boardError } = await supabaseClient
                    .from('boards')
                    .insert({
                        name,
                        owner_id: user.id,
                        invite_code: inviteCode,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (boardError) throw boardError;

                const { error: memberError } = await supabaseClient
                    .from('board_members')
                    .insert({
                        board_id: board.id,
                        user_id: user.id,
                        email: user.email,
                        joined_at: new Date().toISOString()
                    });

                if (memberError) throw memberError;

                setBoards([...boards, board]);
                setCurrentBoardId(board.id);
                return board;
            };

            const joinBoard = async (inviteCode) => {
                const { data: board, error: findError } = await supabaseClient
                    .from('boards')
                    .select('*')
                    .eq('invite_code', inviteCode.toUpperCase())
                    .single();

                if (findError || !board) throw new Error('Invalid invite code');

                const { data: existingMember } = await supabaseClient
                    .from('board_members')
                    .select('*')
                    .eq('board_id', board.id)
                    .eq('user_id', user.id)
                    .single();

                if (existingMember) throw new Error('You are already a member');

                // Add member
                await supabaseClient
                    .from('board_members')
                    .insert({
                        board_id: board.id,
                        user_id: user.id,
                        email: user.email,
                        joined_at: new Date().toISOString()
                    });

                // --- FIX: Mark any pending invitations as accepted ---
                try {
                    console.log('Marking invitation as accepted for:', user.email);
                    await supabaseClient
                        .from('invitations')
                        .update({ status: 'accepted' })
                        .eq('board_id', board.id)
                        .eq('email', user.email);
                } catch (inviteErr) {
                    console.error('Failed to update invitation status (non-critical):', inviteErr);
                }
                // ----------------------------------------------------

                setBoards([...boards, board]);
                setCurrentBoardId(board.id);
                return board;
            };

            const inviteByEmail = async (email) => {
                const board = boards.find(b => b.id === currentBoardId);
                if (!board) throw new Error('No board selected');

                if (supabaseClient) {
                    try {

                        const { data: insertData, error } = await supabaseClient.from('invitations').insert({
                            board_id: board.id,
                            email: email,
                            created_by: user.id,
                            status: 'pending'
                        }).select(); // Add .select() to see what was returned

                        console.log('Invitation insert result:', { data: insertData, error });

                        if (error) console.error('Failed to create invitation record:', error);

                        // Reload data
                        console.log('Triggering loadBoardDetails after invite...');
                        await loadBoardDetails(board.id);
                    } catch (e) { console.error('Invite insert error', e); }
                }

                return {
                    inviteCode: board.invite_code,
                    inviteLink: `${window.location.origin}${window.location.pathname}?invite=${board.invite_code}`
                };
            };

            const leaveBoard = async (boardId) => {
                console.log('Leaving board:', boardId);
                const { error } = await supabaseClient
                    .from('board_members')
                    .delete()
                    .eq('board_id', boardId)
                    .eq('user_id', user.id);

                if (error) {
                    throw error;
                }

                // Remove from local state
                setBoards(boards.filter(b => b.id !== boardId));
                if (currentBoardId === boardId) {
                    setCurrentBoardId(null);
                    window.location.href = window.location.origin + window.location.pathname; // Hard reload to clear view
                }
            };

            const removeMember = async (boardId, memberId) => {
                console.log('Removing member:', memberId, 'from board:', boardId);
                const { error } = await supabaseClient
                    .from('board_members')
                    .delete()
                    .eq('board_id', boardId)
                    .eq('user_id', memberId);

                if (error) {
                    throw error;
                }

                // Update local members list if on this board
                if (currentBoardId === boardId) {
                    await loadBoardDetails(boardId);
                }
            };

            return (
                <AuthContext.Provider value={{
                    user,
                    userProfile,
                    loading,
                    boards,
                    setBoards,
                    currentBoardId,
                    setCurrentBoardId,
                    createBoard,
                    joinBoard,
                    // These functions are typically in BoardProvider, but added to AuthContext as per instruction
                    // They would need to be defined in AuthProvider or passed through from BoardProvider
                    addTopic: () => console.warn('addTopic not implemented in AuthProvider'),
                    updateTopic: () => console.warn('updateTopic not implemented in AuthProvider'),
                    deleteTopic: () => console.warn('deleteTopic not implemented in AuthProvider'),
                    addContribution: () => console.warn('addContribution not implemented in AuthProvider'),
                    updateProfile,
                    sendMagicLink,
                    signInWithPassword,
                    signUp,
                    resetPassword,
                    signOut,
                    supabaseClient,
                    isSupabaseConfigured,
                    isDevMode,
                    devLogin,
                    authError,
                    retryLoad: () => loadUserData(user),
                    inviteByEmail,
                    members,
                    invitations,
                    leaveBoard,
                    removeMember
                }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // ============================================
        // BOARD DATA PROVIDER (SUPABASE)
        // ============================================
        const BoardProvider = ({ children }) => {
            const { user, currentBoardId, isSupabaseConfigured, isDevMode } = useContext(AuthContext);
            const [topics, setTopics] = useState([]);
            const [boardMembers, setBoardMembers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if ((!isSupabaseConfigured && !isDevMode) || !currentBoardId || !user) {
                    setLoading(false);
                    return;
                }

                // Load topics
                const loadTopics = async () => {
                    if (isDevMode) {
                        const dummySuggestedTopic = {
                            id: 'suggested-123',
                            board_id: currentBoardId,
                            title: 'Email: Potential Partnership with ACME',
                            description: 'Received email from bob@acme.com proposing a joint venture.',
                            status: 'suggested',
                            created_by: 'email-agent',
                            created_at: new Date().toISOString(),
                            contributions: []
                        };
                        // Also include the manually created dev topic if it persists, but for now just this default one
                        setTopics([dummySuggestedTopic]);
                        setLoading(false);
                        return; // Topics are in memory for dev mode
                    }
                    const { data } = await supabaseClient
                        .from('topics')
                        .select('*')
                        .eq('board_id', currentBoardId)
                        .order('created_at', { ascending: false });

                    if (data) {
                        setTopics(data);
                    }
                    setLoading(false);
                };

                loadTopics();

                // Subscribe to real-time updates
                const subscription = supabaseClient
                    .channel(`topics:${currentBoardId}`)
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'topics', filter: `board_id=eq.${currentBoardId}` },
                        (payload) => {
                            if (payload.eventType === 'INSERT') {
                                setTopics(prev => [payload.new, ...prev]);
                            } else if (payload.eventType === 'UPDATE') {
                                setTopics(prev => prev.map(t => t.id === payload.new.id ? payload.new : t));
                            } else if (payload.eventType === 'DELETE') {
                                setTopics(prev => prev.filter(t => t.id !== payload.old.id));
                            }
                        }
                    )
                    .subscribe();

                // Load board members
                const loadMembers = async () => {
                    const { data: memberData } = await supabaseClient
                        .from('board_members')
                        .select('user_id, email')
                        .eq('board_id', currentBoardId);

                    if (memberData) {
                        const memberIds = memberData.map(m => m.user_id);
                        const { data: profiles } = await supabaseClient
                            .from('profiles')
                            .select('*')
                            .in('id', memberIds);

                        if (profiles) {
                            setBoardMembers(profiles.map(p => ({
                                uid: p.id,
                                displayName: p.display_name,
                                email: p.email
                            })));
                        }
                    }
                };

                loadMembers();

                return () => {
                    subscription.unsubscribe();
                };
            }, [currentBoardId, user, isSupabaseConfigured]);

            const addTopic = async (topicData) => {
                if (!supabaseClient || isDevMode) {
                    // Dev mode mock
                    const newTopic = {
                        id: generateId(),
                        board_id: currentBoardId,
                        title: topicData.title,
                        description: topicData.description,
                        due_date: topicData.dueDate,
                        rank: topicData.rank, // Add rank
                        status: topicData.status || 'open',
                        created_by: user.id,
                        contributions: [],
                        created_at: new Date().toISOString()
                    };
                    setTopics([newTopic, ...topics]);
                    return;
                }

                const { error } = await supabaseClient
                    .from('topics')
                    .insert({
                        board_id: currentBoardId,
                        title: topicData.title,
                        description: topicData.description,
                        due_date: topicData.dueDate,
                        rank: topicData.rank, // Add rank
                        status: topicData.status || 'open',
                        created_by: user.id,
                        contributions: [],
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;
            };

            const updateTopic = async (topicId, updates) => {
                if (!supabaseClient || isDevMode) {
                    setTopics(topics.map(t => t.id === topicId ? { ...t, ...updates } : t));
                    return;
                }

                const updateData = {};
                if (updates.status) updateData.status = updates.status;
                if (updates.rank) updateData.rank = updates.rank;
                if (updates.contributions) updateData.contributions = updates.contributions;
                if (updates.title) updateData.title = updates.title;
                // Allow title updates too while we are at it, as I saw a title editor earlier

                await supabaseClient
                    .from('topics')
                    .update(updateData)
                    .eq('id', topicId);
            };

            const deleteTopic = async (topicId) => {
                if (!supabaseClient || isDevMode) {
                    setTopics(topics.filter(t => t.id !== topicId));
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('topics')
                    .delete()
                    .eq('id', topicId)
                    .select(); // Must select to get returned rows

                if (error) {
                    console.error('Failed to delete topic:', error);
                    alert('Failed to delete topic: ' + error.message);
                } else if (!data || data.length === 0) {
                    // Silent failure (RLS)
                    console.error('Delete succeeded but no rows returned (RLS blocked?)');
                    alert('Could not delete topic. You might not have permission.');
                } else {
                    // Update local state immediately
                    setTopics(topics.filter(t => t.id !== topicId));
                }
            };

            const addContribution = async (topicId, contribution) => {
                const topic = topics.find(t => t.id === topicId);
                const profile = boardMembers.find(m => m.uid === user.id);

                const newContribution = {
                    ...contribution,
                    id: generateId(),
                    userId: user.id,
                    userEmail: user.email,
                    userName: profile?.displayName || user.email.split('@')[0],
                    createdAt: new Date().toISOString(),
                    replies: []
                };

                if (!supabaseClient || isDevMode) {
                    const updatedTopic = {
                        ...topic,
                        contributions: [...(topic.contributions || []), newContribution]
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                    return;
                }

                const { error } = await supabaseClient
                    .from('topics')
                    .update({
                        contributions: [...(topic.contributions || []), newContribution]
                    })
                    .eq('id', topicId);

                if (error) {
                    console.error('Failed to add contribution:', error);
                    alert('Failed to post contribution: ' + error.message);
                    throw error; // Rethrow so the caller knows it failed
                } else {
                    // Update local state immediately
                    const updatedTopic = {
                        ...topic,
                        contributions: [...(topic.contributions || []), newContribution]
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                }
            };

            const addReply = async (topicId, parentId, reply) => {
                const topic = topics.find(t => t.id === topicId);
                const profile = boardMembers.find(m => m.uid === user.id);

                const newReply = {
                    ...reply,
                    id: generateId(),
                    userId: user.id,
                    userEmail: user.email,
                    userName: profile?.displayName || user.email.split('@')[0],
                    createdAt: new Date().toISOString(),
                    replies: []
                };

                const addReplyToContribution = (contributions) => {
                    return contributions.map(c => {
                        if (c.id === parentId) {
                            return { ...c, replies: [...(c.replies || []), newReply] };
                        }
                        if (c.replies) {
                            return { ...c, replies: addReplyToContribution(c.replies) };
                        }
                        return c;
                    });
                };

                if (!supabaseClient || isDevMode) {
                    const updatedTopic = {
                        ...topic,
                        contributions: addReplyToContribution(topic.contributions || [])
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                    return;
                }

                const { error } = await supabaseClient
                    .from('topics')
                    .update({
                        contributions: addReplyToContribution(topic.contributions || [])
                    })
                    .eq('id', topicId);

                if (error) {
                    console.error('Failed to add reply:', error);
                    alert('Failed to post reply: ' + error.message);
                    throw error;
                } else {
                    // Update local state
                    const updatedTopic = {
                        ...topic,
                        contributions: addReplyToContribution(topic.contributions || [])
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                }
            };

            const deleteContribution = async (topicId, contributionId) => {
                const topic = topics.find(t => t.id === topicId);

                const filterContribution = (contributions) => {
                    return contributions
                        .filter(c => c.id !== contributionId)
                        .map(c => ({
                            ...c,
                            replies: c.replies ? filterContribution(c.replies) : []
                        }));
                };

                const updatedContributions = filterContribution(topic.contributions || []);

                if (!supabaseClient || isDevMode) {
                    const updatedTopic = {
                        ...topic,
                        contributions: updatedContributions
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                    return;
                }

                const { error } = await supabaseClient
                    .from('topics')
                    .update({
                        contributions: updatedContributions
                    })
                    .eq('id', topicId);

                if (error) {
                    console.error('Failed to delete contribution:', error);
                    alert('Failed to delete contribution: ' + error.message);
                } else {
                    // Update local state if successful
                    const updatedTopic = {
                        ...topic,
                        contributions: updatedContributions
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                }
            };

            return (
                <BoardContext.Provider value={{
                    topics,
                    boardMembers,
                    loading,
                    addTopic,
                    updateTopic,
                    deleteTopic,
                    addContribution,
                    addReply,
                    deleteContribution
                }}>
                    {children}
                </BoardContext.Provider>
            );
        };

        // ============================================
        // UI COMPONENTS
        // ============================================

        // Loading spinner
        const Spinner = () => (
            <div className="flex items-center justify-center p-8">
                <div className="w-8 h-8 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
            </div>
        );

        // Category badge component
        const CategoryBadge = ({ category }) => {
            const colors = {
                opinion: 'bg-purple-100 text-purple-800 border-purple-200',
                fact: 'bg-blue-100 text-blue-800 border-blue-200',
                preference: 'bg-green-100 text-green-800 border-green-200',
                ai_summary: 'bg-indigo-100 text-indigo-800 border-indigo-200'
            };
            const labels = {
                opinion: 'Opinion',
                fact: 'Fact',
                preference: 'Preference',
                ai_summary: 'AI Summary'
            };
            return (
                <span className={`px-2 py-1 text-xs font-medium rounded-full border ${colors[category] || colors.opinion}`}>
                    {labels[category] || category.charAt(0).toUpperCase() + category.slice(1)}
                </span>
            );
        };

        // User badge component
        const UserBadge = ({ userName, isCurrentUser }) => {
            return (
                <span className={`px-2 py-1 text-xs font-medium text-white rounded-full ${isCurrentUser ? 'bg-gray-900' : 'bg-gray-500'
                    }`}>
                    {userName} {isCurrentUser && '(you)'}
                </span>
            );
        };

        // Status badge component
        const StatusBadge = ({ status }) => {
            const colors = {
                open: 'bg-yellow-100 text-yellow-800',
                pending: 'bg-orange-100 text-orange-800',
                decided: 'bg-green-100 text-green-800'
            };
            return (
                <span className={`px-2 py-1 text-xs font-medium rounded ${colors[status]}`}>
                    {status.charAt(0).toUpperCase() + status.slice(1)}
                </span>
            );
        };

        // Voice recorder component
        const VoiceRecorder = ({ onRecordingComplete }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [duration, setDuration] = useState(0);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);

            // Transcription refs
            const recognitionRef = useRef(null);
            const transcriptRef = useRef('');

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];

                    // Reset transcript
                    transcriptRef.current = '';

                    const provider = localStorage.getItem('transcriptionProvider') || 'browser';

                    // Initialize Browser Native Transcription
                    if (provider === 'browser' && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        recognitionRef.current = new SpeechRecognition();
                        recognitionRef.current.continuous = true;
                        recognitionRef.current.interimResults = true;

                        recognitionRef.current.onresult = (event) => {
                            let interimTranscript = '';
                            let finalTranscript = '';

                            for (let i = event.resultIndex; i < event.results.length; ++i) {
                                if (event.results[i].isFinal) {
                                    finalTranscript += event.results[i][0].transcript;
                                } else {
                                    interimTranscript += event.results[i][0].transcript;
                                }
                            }
                            // Store full transcript (accumulated)
                            // Note: For simplicity in this v1, we just append final results. 
                            // A more robust impl might handle interim display.
                            if (finalTranscript) {
                                transcriptRef.current += finalTranscript + ' ';
                            }
                        };

                        recognitionRef.current.onerror = (event) => {
                            console.error('Speech recognition error', event.error);
                        };

                        recognitionRef.current.start();
                    }

                    mediaRecorderRef.current.ondataavailable = (e) => {
                        chunksRef.current.push(e.data);
                    };

                    mediaRecorderRef.current.onstop = async () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const reader = new FileReader();

                        // Stop recognition if active
                        if (recognitionRef.current) {
                            recognitionRef.current.stop();
                        }

                        // Handle OpenAI if selected (Scaffolding)
                        if (provider === 'openai') {
                            const apiKey = localStorage.getItem('openaiApiKey');
                            if (!apiKey) {
                                alert('Please set your OpenAI API Key in Settings to use Whisper transcription.');
                            } else {
                                // TODO: Implement actual Whisper API call here
                                transcriptRef.current = "[OpenAI Whisper integration coming soon]";
                            }
                        }

                        reader.onloadend = () => {
                            onRecordingComplete({
                                data: reader.result,
                                duration: duration,
                                transcript: transcriptRef.current.trim()
                            });
                        };
                        reader.readAsDataURL(blob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setDuration(0);
                    timerRef.current = setInterval(() => {
                        setDuration(d => d + 1);
                    }, 1000);
                } catch (err) {
                    console.error('Recording error:', err);
                    alert('Could not access microphone. Please ensure microphone permissions are granted.');
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    clearInterval(timerRef.current);
                }
            };

            return (
                <div className="flex items-center gap-3">
                    {!isRecording ? (
                        <button
                            onClick={startRecording}
                            className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                        >
                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="10" cy="10" r="6" />
                            </svg>
                            Record Voice Note
                        </button>
                    ) : (
                        <div className="flex items-center gap-3">
                            <div className="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg">
                                <span className="w-3 h-3 bg-red-500 rounded-full recording-pulse"></span>
                                Recording... {formatDuration(duration)}
                            </div>
                            <button
                                onClick={stopRecording}
                                className="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors"
                            >
                                Stop
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // Audio player component
        const AudioPlayer = ({ audioData, duration }) => {
            const audioRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);

            useEffect(() => {
                const audio = audioRef.current;
                if (audio) {
                    audio.ontimeupdate = () => setCurrentTime(audio.currentTime);
                    audio.onended = () => setIsPlaying(false);
                }
            }, []);

            const togglePlay = () => {
                if (audioRef.current) {
                    if (isPlaying) {
                        audioRef.current.pause();
                    } else {
                        audioRef.current.play();
                    }
                    setIsPlaying(!isPlaying);
                }
            };

            return (
                <div className="flex items-center gap-3 p-3 bg-gray-100 rounded-lg">
                    <audio ref={audioRef} src={audioData} />
                    <button
                        onClick={togglePlay}
                        className="w-10 h-10 flex items-center justify-center bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-colors"
                    >
                        {isPlaying ? (
                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <rect x="5" y="4" width="3" height="12" />
                                <rect x="12" y="4" width="3" height="12" />
                            </svg>
                        ) : (
                            <svg className="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                <polygon points="5,3 19,10 5,17" />
                            </svg>
                        )}
                    </button>
                    <div className="flex-1">
                        <div className="h-2 bg-gray-300 rounded-full overflow-hidden">
                            <div
                                className="h-full bg-gray-900 transition-all duration-100"
                                style={{ width: `${(currentTime / (duration || 1)) * 100}%` }}
                            />
                        </div>
                    </div>
                    <span className="text-sm text-gray-600 font-mono">
                        {formatDuration(currentTime)} / {formatDuration(duration)}
                    </span>
                </div>
            );
        };

        // Contribution component
        const Contribution = ({ contribution, topicId, level = 0, onDelete }) => {
            const { user } = useContext(AuthContext);
            const { addReply } = useContext(BoardContext);
            const [showReplyForm, setShowReplyForm] = useState(false);
            const [confirmDelete, setConfirmDelete] = useState(false);

            const isCurrentUser = contribution.userId === user?.id;
            const isAISummary = contribution.category === 'ai_summary';

            const handleReply = async (replyData) => {
                await addReply(topicId, contribution.id, replyData);
                setShowReplyForm(false);
            };

            const handleDelete = () => {
                if (confirmDelete) {
                    onDelete && onDelete(contribution.id);
                    setConfirmDelete(false);
                } else {
                    setConfirmDelete(true);
                    // Auto-cancel after 3 seconds
                    setTimeout(() => setConfirmDelete(false), 3000);
                }
            };

            return (
                <div className={`${level > 0 ? 'ml-8 border-l-2 border-gray-200 pl-4' : ''}`}>
                    <div className={`rounded-lg border p-4 mb-3 shadow-sm ${isAISummary
                        ? 'bg-blue-50 border-blue-200'
                        : 'bg-white border-gray-200'
                        }`}>
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <UserBadge userName={contribution.userName} isCurrentUser={isCurrentUser} />
                                <CategoryBadge category={contribution.category} />
                                <span className="text-sm text-gray-500">
                                    {formatDate(contribution.createdAt)}
                                </span>
                            </div>
                            <div className="flex items-center gap-2">
                                {contribution.isApproval && (
                                    <span className="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full">
                                         Approved
                                    </span>
                                )}
                                {isCurrentUser && onDelete && (
                                    <button
                                        onClick={handleDelete}
                                        className={`px-2 py-1 text-xs font-medium rounded transition-colors ${confirmDelete
                                            ? 'bg-red-600 text-white hover:bg-red-700'
                                            : 'text-gray-400 hover:text-red-600 hover:bg-red-50'
                                            }`}
                                        title={confirmDelete ? 'Click again to confirm' : 'Delete'}
                                    >
                                        {confirmDelete ? 'Confirm Delete?' : ''}
                                    </button>
                                )}
                            </div>
                        </div>

                        {contribution.text && (
                            contribution.category === 'ai_summary' ? (
                                <div className="text-gray-700 mb-3 prose prose-sm max-w-none">
                                    {contribution.text.split('\n').map((line, idx) => {
                                        // Basic markdown-like rendering for AI summaries
                                        let formattedLine = line
                                            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                                            .replace(/^### (.+)$/, '<strong class="text-gray-800">$1</strong>')
                                            .replace(/^## (.+)$/, '<strong class="text-gray-900 text-base">$1</strong>')
                                            .replace(/^- (.+)$/, ' $1');

                                        if (line.trim() === '') {
                                            return <br key={idx} />;
                                        }
                                        return (
                                            <p
                                                key={idx}
                                                className="mb-1"
                                                dangerouslySetInnerHTML={{ __html: formattedLine }}
                                            />
                                        );
                                    })}
                                </div>
                            ) : (
                                <p className="text-gray-700 mb-3">{contribution.text}</p>
                            )
                        )}

                        {contribution.voiceNote && (
                            <div className="mb-3">
                                <AudioPlayer
                                    audioData={contribution.voiceNote.data}
                                    duration={contribution.voiceNote.duration}
                                />
                                {contribution.voiceNote.transcript && (
                                    <div className="mt-2">
                                        <details className="group">
                                            <summary className="flex items-center gap-2 text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-900 select-none">
                                                <svg className="w-4 h-4 transition-transform group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                                </svg>
                                                Show Transcript
                                            </summary>
                                            <div className="mt-2 pl-6 relative">
                                                <div className="p-3 bg-gray-50 rounded-lg text-sm text-gray-700 italic border border-gray-100">
                                                    "{contribution.voiceNote.transcript}"
                                                </div>
                                                <button
                                                    onClick={() => navigator.clipboard.writeText(contribution.voiceNote.transcript)}
                                                    className="absolute top-2 right-2 p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded transition-colors"
                                                    title="Copy transcript"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </details>
                                    </div>
                                )}
                            </div>
                        )}

                        {contribution.links && contribution.links.length > 0 && (
                            <div className="mb-3">
                                <h4 className="text-sm font-medium text-gray-600 mb-2">Attached Links:</h4>
                                <div className="space-y-1">
                                    {contribution.links.map((link, idx) => (
                                        <a
                                            key={idx}
                                            href={link.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="flex items-center gap-2 text-blue-600 hover:text-blue-800 text-sm"
                                        >
                                            {link.url.includes('docs.google.com') && <span className="text-blue-500"></span>}
                                            {link.url.includes('drive.google.com') && <span className="text-green-500"></span>}
                                            {link.url.includes('sheets.google.com') && <span className="text-green-600"></span>}
                                            {!link.url.includes('google.com') && <span></span>}
                                            {link.title || link.url}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}

                        <button
                            onClick={() => setShowReplyForm(!showReplyForm)}
                            className="text-sm text-gray-600 hover:text-gray-900 font-medium"
                        >
                            {showReplyForm ? 'Cancel Reply' : 'Reply'}
                        </button>

                        {showReplyForm && (
                            <div className="mt-3 pt-3 border-t border-gray-200">
                                <ContributionForm onSubmit={handleReply} isReply={true} />
                            </div>
                        )}
                    </div>

                    {contribution.replies && contribution.replies.map(reply => (
                        <Contribution
                            key={reply.id}
                            contribution={reply}
                            topicId={topicId}
                            level={level + 1}
                            onDelete={onDelete}
                        />
                    ))}
                </div>
            );
        };

        // Contribution form component
        const ContributionForm = ({ onSubmit, isReply = false }) => {
            const [text, setText] = useState('');
            const [category, setCategory] = useState('opinion');
            const [voiceNote, setVoiceNote] = useState(null);
            const [links, setLinks] = useState([]);
            const [linkInput, setLinkInput] = useState('');
            const [isApproval, setIsApproval] = useState(false);
            const [submitting, setSubmitting] = useState(false);

            const addLink = () => {
                if (linkInput.trim()) {
                    setLinks([...links, { url: linkInput.trim(), title: '' }]);
                    setLinkInput('');
                }
            };

            const removeLink = (idx) => {
                setLinks(links.filter((_, i) => i !== idx));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!text.trim() && !voiceNote && links.length === 0) {
                    alert('Please add some content (text, voice note, or links)');
                    return;
                }
                setSubmitting(true);
                try {
                    await onSubmit({
                        category,
                        text: text.trim(),
                        voiceNote,
                        links,
                        isApproval
                    });
                    setText('');
                    setCategory('opinion');
                    setVoiceNote(null);
                    setLinks([]);
                    setIsApproval(false);
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="flex gap-4 flex-wrap items-end">
                        <div className="flex-1 sm:flex-none">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="rounded-lg border-gray-300 text-sm focus:ring-gray-900 focus:border-gray-900"
                            >
                                <option value="opinion">Opinion</option>
                                <option value="fact">Fact</option>
                                <option value="preference">Preference</option>
                                <option value="request">Request</option>
                            </select>
                        </div>
                        {isReply && (
                            <div className="flex items-end">
                                <label className="flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-lg cursor-pointer hover:bg-green-100">
                                    <input
                                        type="checkbox"
                                        checked={isApproval}
                                        onChange={(e) => setIsApproval(e.target.checked)}
                                        className="w-4 h-4 text-green-600"
                                    />
                                    <span className="text-green-700 font-medium">Mark as Approval</span>
                                </label>
                            </div>
                        )}
                        <button
                            type="submit"
                            disabled={submitting}
                            className="ml-auto px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
                        >
                            {submitting ? 'Posting...' : isReply ? 'Post Reply' : 'Add Contribution'}
                        </button>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Your Input</label>
                        <textarea
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            placeholder="Share your thoughts, facts, or preferences..."
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent resize-none"
                            rows={3}
                        />
                    </div>

                    <div className="flex flex-col md:flex-row gap-4">
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Voice Note</label>
                            {voiceNote ? (
                                <div className="space-y-2">
                                    <AudioPlayer audioData={voiceNote.data} duration={voiceNote.duration} />
                                    <button
                                        type="button"
                                        onClick={() => setVoiceNote(null)}
                                        className="text-sm text-red-600 hover:text-red-800"
                                    >
                                        Remove recording
                                    </button>
                                </div>
                            ) : (
                                <VoiceRecorder onRecordingComplete={setVoiceNote} />
                            )}
                        </div>

                        <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Document Links</label>
                            <div className="flex gap-2 mb-2">
                                <input
                                    type="url"
                                    value={linkInput}
                                    onChange={(e) => setLinkInput(e.target.value)}
                                    placeholder="Paste URL here..."
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addLink())}
                                />
                                <button
                                    type="button"
                                    onClick={addLink}
                                    className="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium"
                                >
                                    Add
                                </button>
                            </div>
                            <div className="space-y-1">
                                {links.map((link, idx) => (
                                    <div key={idx} className="flex items-center gap-2 text-sm bg-gray-50 px-2 py-1 rounded border border-gray-100">
                                        <svg className="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                                        <a href={link.url} target="_blank" rel="noopener noreferrer" className="flex-1 truncate text-blue-600 hover:underline">{link.url}</a>
                                        <button type="button" onClick={() => removeLink(idx)} className="text-gray-400 hover:text-red-500"></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </form>
            );
        };

        // Topic form component
        const TopicForm = ({ onSubmit, onCancel }) => {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [rank, setRank] = useState('');
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!title.trim()) return;
                setSubmitting(true);
                try {
                    await onSubmit({
                        title: title.trim(),
                        description: description.trim(),
                        dueDate: dueDate || null,
                        rank: rank || null,
                        status: 'open'
                    });
                } catch (err) {
                    console.error('Error creating topic:', err);
                    alert('Failed to create topic: ' + (err.message || 'Unknown error'));
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4 p-4 bg-white rounded-lg border border-gray-200">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Topic Title *</label>
                        <input
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="e.g., Q1 Marketing Budget Allocation"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="Provide context about this decision..."
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent resize-none"
                            rows={2}
                        />
                    </div>
                    <div className="flex gap-4">
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input
                                type="date"
                                value={dueDate}
                                onChange={(e) => setDueDate(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            />
                        </div>
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Rank</label>
                            <select
                                value={rank}
                                onChange={(e) => setRank(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            >
                                <option value="">No Rank</option>
                                <option value="A">Rank A</option>
                                <option value="B">Rank B</option>
                                <option value="C">Rank C</option>
                            </select>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <button
                            type="submit"
                            disabled={submitting}
                            className="flex-1 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                        >
                            {submitting ? 'Creating...' : 'Create Topic'}
                        </button>
                        <button
                            type="button"
                            onClick={onCancel}
                            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            );
        };

        // AI Summary component
        const AISummary = ({ topic, onSaveAsContribution }) => {
            const { supabaseClient } = useContext(AuthContext);
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            // Get previous AI summaries from contributions
            const getPreviousSummaries = () => {
                const summaries = [];
                const gatherSummaries = (contributions) => {
                    contributions.forEach(c => {
                        if (c.category === 'ai_summary') {
                            summaries.push({
                                text: c.text,
                                createdAt: c.createdAt,
                                userName: c.userName
                            });
                        }
                        if (c.replies?.length) {
                            gatherSummaries(c.replies);
                        }
                    });
                };
                gatherSummaries(topic.contributions || []);
                return summaries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            };

            const generateSummary = async () => {
                setLoading(true);
                setError(null);

                const gatherText = (contributions, prefix = '') => {
                    let text = '';
                    contributions.forEach(c => {
                        if (c.category === 'ai_summary') return;
                        let content = c.text || '';
                        if (c.voiceNote?.transcript) {
                            content += ` (Transcript: "${c.voiceNote.transcript}")`;
                        } else if (c.voiceNote && !c.text) {
                            content += ' (voice note)';
                        }
                        text += `${prefix}[${c.userName}] (${c.category}): ${content}\n`;
                        if (c.links?.length) {
                            text += `${prefix}  Links: ${c.links.map(l => l.url).join(', ')}\n`;
                        }
                        if (c.isApproval) {
                            text += `${prefix}  ** APPROVED **\n`;
                        }
                        if (c.replies?.length) {
                            text += gatherText(c.replies, prefix + '   ');
                        }
                    });
                    return text;
                };

                const contributionText = gatherText(topic.contributions || []);
                const previousSummaries = getPreviousSummaries();
                const lastSummary = previousSummaries[0];

                let prompt = `You are helping cofounders make decisions asynchronously.

Topic: ${topic.title}
Description: ${topic.description || 'No description'}
Status: ${topic.status}

Contributions:
${contributionText || 'No contributions yet'}

Please provide:
1. A brief summary of the discussion so far
2. Each person's stated preferences or positions
3. Key facts mentioned
4. Any agreements or approvals given
5. What still needs to be decided or discussed`;

                if (lastSummary) {
                    prompt += `

PREVIOUS AI SUMMARY (generated ${new Date(lastSummary.createdAt).toLocaleString()}):
${lastSummary.text}

6. **Changes Since Last Summary**: Compare the current state to the previous AI summary. What has changed? What new information, positions, or decisions have emerged?`;
                }

                prompt += `\n\nKeep it concise and actionable. Use markdown formatting with headers (##) and bullet points.`;

                try {
                    // Call the Edge Function instead of Claude directly
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-proxy`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}`
                        },
                        body: JSON.stringify({
                            provider: 'claude',
                            model: 'claude-sonnet-4-20250514',
                            maxTokens: 1500,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error || 'API request failed');
                    }

                    const data = await response.json();
                    const generatedSummary = data.content?.[0]?.text || 'No summary generated';
                    setSummary(generatedSummary);

                    // Auto-save to discussion and clear the summary box
                    if (onSaveAsContribution) {
                        await onSaveAsContribution({
                            text: generatedSummary,
                            category: 'ai_summary',
                            links: []
                        });
                        // Clear the summary box after depositing to feed
                        setSummary(null);
                    }
                } catch (err) {
                    setError('Failed to generate summary: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-gray-50 rounded-lg border border-gray-200 p-4">
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                            <span></span> AI Summary
                        </h3>
                        <button
                            onClick={generateSummary}
                            disabled={loading}
                            className="px-4 py-1.5 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Generating...' : 'Generate Summary'}
                        </button>
                    </div>

                    {error && <p className="text-red-600 text-sm">{error}</p>}

                    {summary && (
                        <div className="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap bg-blue-50 rounded-lg p-3 border border-blue-100">
                            <p className="text-xs text-blue-600 mb-2"> Auto-saved to discussion</p>
                            {summary}
                        </div>
                    )}

                    {!summary && !error && !loading && (
                        <p className="text-gray-500 text-sm">
                            Click "Generate Summary" to get an AI-powered overview of this topic's discussion.
                            {getPreviousSummaries().length > 0 && ' The new summary will include a comparison to the previous one.'}
                        </p>
                    )}
                </div>
            );
        };

        // ============================================
        // LOGIN SCREEN
        // ============================================
        // ============================================
        // LOGIN SCREEN
        // ============================================
        const LoginScreen = () => {
            const { sendMagicLink, signInWithPassword, signUp, resetPassword, isSupabaseConfigured, devLogin } = useContext(AuthContext);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [sent, setSent] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [authMode, setAuthMode] = useState('password'); // 'password' or 'magic'
            const [isSignUp, setIsSignUp] = useState(false);
            const [isForgotPassword, setIsForgotPassword] = useState(false);

            const handlePasswordSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isSignUp) {
                        await signUp(email, password);
                        setSent(true);
                    } else {
                        await signInWithPassword(email, password);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleMagicLinkSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await sendMagicLink(email);
                    setSent(true);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleForgotPasswordSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await resetPassword(email);
                    setSent(true);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!isSupabaseConfigured) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="flex justify-center mb-4">
                                    <TenexityLogo size={64} />
                                </div>
                                <TenexityLogoFull height={28} />
                                <p className="text-gray-500 mt-4">Decision Board</p>
                                <p className="text-amber-600 mt-2 text-sm font-medium">Supabase Setup Required</p>
                            </div>

                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                                <h3 className="font-semibold text-amber-800 mb-2"> Configuration Needed</h3>
                                <p className="text-amber-700 text-sm mb-3">
                                    To enable user authentication and real-time sync, you need to set up Supabase:
                                </p>
                                <ol className="text-amber-700 text-sm space-y-2 list-decimal list-inside">
                                    <li>Go to <a href="https://supabase.com" target="_blank" className="underline">supabase.com</a></li>
                                    <li>Create a new project</li>
                                    <li>Run the database schema (see setup guide)</li>
                                    <li>Copy your URL and anon key to this file</li>
                                </ol>
                            </div>

                            <p className="text-gray-500 text-sm text-center">
                                See the setup instructions file for detailed steps.
                            </p>

                            <div className="mt-6 pt-6 border-t border-gray-100">
                                <button
                                    onClick={devLogin}
                                    className="w-full py-2 bg-gray-100 text-gray-600 font-medium rounded-lg hover:bg-gray-200 transition-colors text-sm"
                                >
                                     Bypass Login (Developer Mode)
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (sent) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md text-center">
                            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span className="text-green-600 text-3xl"></span>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Check Your Email</h2>
                            <p className="text-gray-600 mb-4">
                                {isForgotPassword
                                    ? <span>We sent a password reset link to <strong>{email}</strong></span>
                                    : <span>We sent {isSignUp ? 'a confirmation link' : 'a magic link'} to <strong>{email}</strong></span>
                                }
                            </p>
                            <p className="text-gray-500 text-sm">
                                Click the link in the email to {isForgotPassword ? 'reset your password' : (isSignUp ? 'confirm your account' : 'sign in')}.
                            </p>
                            <button
                                onClick={() => { setSent(false); setError(''); }}
                                className="mt-4 text-gray-600 text-sm underline hover:text-gray-800"
                            >
                                Back to login
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <TenexityLogoFull height={48} />
                            <h2 className="text-xl font-bold text-gray-900 mt-2">Decision Engine</h2>
                            <p className="text-gray-500 mt-1">{isForgotPassword ? 'Reset Password' : 'Sign in to collaborate'}</p>
                        </div>

                        {/* Back Button for Forgot Password */}
                        {isForgotPassword && (
                            <button
                                onClick={() => setIsForgotPassword(false)}
                                className="mb-6 flex items-center text-sm text-gray-500 hover:text-gray-900"
                            >
                                 Back to login
                            </button>
                        )}

                        {/* Forgot Password Logic */}
                        {isForgotPassword ? (
                            <form onSubmit={handleForgotPasswordSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@example.com"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                        required
                                    />
                                </div>
                                {error && (
                                    <p className="text-red-600 text-sm">{error}</p>
                                )}
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                >
                                    {loading ? 'Sending...' : 'Send Reset Link'}
                                </button>
                            </form>
                        ) : (
                            <>
                                {/* Auth Mode Toggle */}
                                <div className="flex rounded-lg bg-gray-100 p-1 mb-6">
                                    <button
                                        type="button"
                                        onClick={() => setAuthMode('password')}
                                        className={`flex-1 py-2 text-sm font-medium rounded-md transition-colors ${authMode === 'password'
                                            ? 'bg-white text-gray-900 shadow-sm'
                                            : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                    >
                                        Email & Password
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setAuthMode('magic')}
                                        className={`flex-1 py-2 text-sm font-medium rounded-md transition-colors ${authMode === 'magic'
                                            ? 'bg-white text-gray-900 shadow-sm'
                                            : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                    >
                                        Magic Link
                                    </button>
                                </div>

                                {authMode === 'password' ? (
                                    <form onSubmit={handlePasswordSubmit} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                placeholder="you@example.com"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                            <input
                                                type="password"
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                placeholder="Enter your password"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                                required
                                                minLength={6}
                                            />
                                            <div className="flex justify-end mt-1">
                                                <button
                                                    type="button"
                                                    onClick={() => setIsForgotPassword(true)}
                                                    className="text-xs text-gray-600 hover:text-gray-900"
                                                >
                                                    Forgot password?
                                                </button>
                                            </div>
                                        </div>

                                        {error && (
                                            <p className="text-red-600 text-sm">{error}</p>
                                        )}

                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                        >
                                            {loading ? (isSignUp ? 'Creating account...' : 'Signing in...') : (isSignUp ? 'Create Account' : 'Sign In')}
                                        </button>

                                        <p className="text-center text-sm text-gray-600">
                                            {isSignUp ? (
                                                <>Already have an account? <button type="button" onClick={() => setIsSignUp(false)} className="text-gray-900 font-medium hover:underline">Sign in</button></>
                                            ) : (
                                                <>Don't have an account? <button type="button" onClick={() => setIsSignUp(true)} className="text-gray-900 font-medium hover:underline">Sign up</button></>
                                            )}
                                        </p>
                                    </form>
                                ) : (
                                    /* Magic Link Form */
                                    <form onSubmit={handleMagicLinkSubmit} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                placeholder="you@example.com"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                                required
                                            />
                                        </div>
                                        {error && (
                                            <p className="text-red-600 text-sm">{error}</p>
                                        )}
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                        >
                                            {loading ? 'Sending link...' : 'Send Magic Link'}
                                        </button>
                                        <p className="text-center text-sm text-gray-600">
                                            We'll send you a link to sign in instantly.
                                        </p>
                                    </form>
                                )}
                            </>
                        )}

                        <div className="mt-8 pt-6 border-t border-gray-100">
                            <button
                                onClick={devLogin}
                                className="w-full py-2 bg-gray-50 text-gray-500 font-medium rounded-lg hover:bg-gray-100 transition-colors text-sm"
                            >
                                Developer Login
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // ONBOARDING SCREEN
        // ============================================
        const OnboardingScreen = () => {
            const { createBoard, joinBoard, userProfile, updateProfile } = useContext(AuthContext);
            const [step, setStep] = useState('choice'); // Skip 'name' step by default
            const [displayName, setDisplayName] = useState(userProfile?.displayName || '');
            const [boardName, setBoardName] = useState('');
            const [inviteCode, setInviteCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const invite = params.get('invite');
                if (invite) {
                    setInviteCode(invite);
                    setStep('join');
                }
            }, []);

            const handleNameSubmit = async (e) => {
                e.preventDefault();
                if (!displayName.trim()) return;
                setLoading(true);
                setError('');
                try {
                    await updateProfile({ displayName: displayName.trim() });
                    setStep('choice');
                } catch (err) {
                    console.error('Profile update error:', err);
                    setError(err.message || 'Failed to save profile');
                    alert('Failed to save profile: ' + (err.message || 'Unknown error'));
                } finally {
                    setLoading(false);
                }
            };

            const handleCreateBoard = async (e) => {
                e.preventDefault();
                if (!boardName.trim()) return;
                setLoading(true);
                setError('');
                try {
                    await createBoard(boardName.trim());
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleJoinBoard = async (e) => {
                e.preventDefault();
                if (!inviteCode.trim()) return;
                setLoading(true);
                setError('');
                try {
                    await joinBoard(inviteCode.trim());
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md">
                        {step === 'name' && (
                            <>
                                <div className="text-center mb-8">
                                    <TenexityLogo size={48} className="mx-auto mb-4" />
                                    <h2 className="text-2xl font-bold text-gray-900">Welcome! </h2>
                                    <p className="text-gray-500 mt-2">What should we call you?</p>
                                </div>
                                <form onSubmit={handleNameSubmit} className="space-y-4">
                                    <input
                                        type="text"
                                        value={displayName}
                                        onChange={(e) => setDisplayName(e.target.value)}
                                        placeholder="Your name"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent text-center text-lg"
                                        required
                                    />
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                    >
                                        Continue
                                    </button>
                                </form>
                            </>
                        )}

                        {step === 'choice' && (
                            <>
                                <div className="text-center mb-8">
                                    <TenexityLogo size={48} className="mx-auto mb-4" />
                                    <h2 className="text-2xl font-bold text-gray-900">Hi, {displayName}!</h2>
                                    <p className="text-gray-500 mt-2">How would you like to get started?</p>
                                </div>
                                <div className="space-y-4">
                                    <button
                                        onClick={() => setStep('create')}
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-gray-900 hover:bg-gray-50 transition-colors text-left"
                                    >
                                        <div className="font-semibold text-gray-900">Create a New Board</div>
                                        <div className="text-sm text-gray-500">Start fresh and invite your cofounder</div>
                                    </button>
                                    <button
                                        onClick={() => setStep('join')}
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-gray-400 hover:bg-gray-50 transition-colors text-left"
                                    >
                                        <div className="font-semibold text-gray-900">Join an Existing Board</div>
                                        <div className="text-sm text-gray-500">I have an invite code</div>
                                    </button>
                                </div>
                            </>
                        )}

                        {step === 'create' && (
                            <>
                                <button onClick={() => setStep('choice')} className="text-gray-500 hover:text-gray-700 mb-4">
                                     Back
                                </button>
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-900">Create Your Board</h2>
                                    <p className="text-gray-500 mt-2">Give your decision board a name</p>
                                </div>
                                <form onSubmit={handleCreateBoard} className="space-y-4">
                                    <input
                                        type="text"
                                        value={boardName}
                                        onChange={(e) => setBoardName(e.target.value)}
                                        placeholder="e.g., Graham & Nick Decisions"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                        required
                                    />
                                    {error && <p className="text-red-600 text-sm">{error}</p>}
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                    >
                                        {loading ? 'Creating...' : 'Create Board'}
                                    </button>
                                </form>
                            </>
                        )}

                        {step === 'join' && (
                            <>
                                <button onClick={() => setStep('choice')} className="text-gray-500 hover:text-gray-700 mb-4">
                                     Back
                                </button>
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-900">Join a Board</h2>
                                    <p className="text-gray-500 mt-2">Enter the invite code from your cofounder</p>
                                </div>
                                <form onSubmit={handleJoinBoard} className="space-y-4">
                                    <input
                                        type="text"
                                        value={inviteCode}
                                        onChange={(e) => setInviteCode(e.target.value.toUpperCase())}
                                        placeholder="XXXXXXXX"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent text-center text-2xl tracking-widest font-mono"
                                        maxLength={8}
                                        required
                                    />
                                    {error && <p className="text-red-600 text-sm">{error}</p>}
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                    >
                                        {loading ? 'Joining...' : 'Join Board'}
                                    </button>
                                </form>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // ============================================
        // INVITE MODAL
        // ============================================
        const InviteModal = ({ isOpen, onClose }) => {
            const { boards, currentBoardId, inviteByEmail } = useContext(AuthContext);
            const [email, setEmail] = useState('');
            const [inviteInfo, setInviteInfo] = useState(null);
            const [copied, setCopied] = useState(false);

            const currentBoard = boards.find(b => b.id === currentBoardId);

            useEffect(() => {
                if (isOpen && currentBoard) {
                    setInviteInfo({
                        inviteCode: currentBoard.invite_code,
                        inviteLink: `${window.location.origin}${window.location.pathname}?invite=${currentBoard.invite_code}`
                    });
                }
            }, [isOpen, currentBoard]);

            const copyLink = () => {
                navigator.clipboard.writeText(inviteInfo?.inviteLink);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const sendEmail = async () => {
                alert(`Share this link with ${email}:\n${inviteInfo?.inviteLink}`);
                setEmail('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-xl font-bold">Invite Your Cofounder</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"></button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Share Invite Link
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={inviteInfo?.inviteLink || ''}
                                        readOnly
                                        className="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm"
                                    />
                                    <button
                                        onClick={copyLink}
                                        className="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800"
                                    >
                                        {copied ? ' Copied' : 'Copy'}
                                    </button>
                                </div>
                            </div>

                            <div className="bg-gray-50 rounded-lg p-4 text-center">
                                <p className="text-sm text-gray-600 mb-2">Or share this invite code:</p>
                                <div className="text-3xl font-mono font-bold text-gray-900 tracking-widest">
                                    {inviteInfo?.inviteCode}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Send via Email
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="cofounder@example.com"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                                    />
                                    <button
                                        onClick={sendEmail}
                                        disabled={!email}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                                    >
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // SETTINGS MODAL
        // ============================================
        const SettingsModal = ({ isOpen, onClose }) => {
            const {
                user,
                userProfile,
                updateProfile,
                signOut,
                members,
                invitations,
                inviteByEmail,
                boards,
                currentBoardId,
                leaveBoard,
                removeMember
            } = useContext(AuthContext);
            const [displayName, setDisplayName] = useState(userProfile?.displayName || '');
            const [emailNotifications, setEmailNotifications] = useState(userProfile?.email_notifications || false);
            const [emailWatcherEnabled, setEmailWatcherEnabled] = useState(() => {
                return localStorage.getItem('emailWatcherEnabled') === 'true';
            });

            // Transcription Settings
            const [transcriptionProvider, setTranscriptionProvider] = useState(() => {
                return localStorage.getItem('transcriptionProvider') || 'browser';
            });

            const [saving, setSaving] = useState(false);

            const currentBoard = boards.find(b => b.id === currentBoardId);
            const isOwner = currentBoard?.owner_id === user?.id;

            const handleRemoveMember = async (memberId) => {
                if (!confirm('Are you sure you want to remove this member?')) return;
                try {
                    await removeMember(currentBoardId, memberId);
                } catch (e) {
                    alert('Failed to remove member: ' + e.message);
                }
            };

            const handleLeaveBoard = async () => {
                if (!confirm('Are you sure you want to leave this board?')) return;
                try {
                    await leaveBoard(currentBoardId);
                    onClose();
                } catch (e) {
                    alert('Failed to leave board: ' + e.message);
                }
            };

            if (!isOpen) return null;

            const handleSave = async () => {
                setSaving(true);
                try {
                    localStorage.setItem('emailWatcherEnabled', emailWatcherEnabled.toString());
                    localStorage.setItem('transcriptionProvider', transcriptionProvider);

                    if (displayName !== userProfile?.displayName || emailNotifications !== userProfile?.email_notifications) {
                        await updateProfile({
                            displayName,
                            email_notifications: emailNotifications
                        });
                    }
                    onClose();
                } catch (err) {
                    console.error('Settings save error:', err);
                    alert('Failed to save settings: ' + (err.message || JSON.stringify(err) || 'Unknown error'));
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md">
                        <h2 className="text-xl font-bold mb-6">Settings</h2>

                        <div className="space-y-6">


                            {/* Team Members Section */}
                            <div className="pt-4 border-t border-gray-100">
                                <label className="block text-sm font-medium text-gray-700 mb-3">Team Members</label>

                                <div className="space-y-3 mb-4">
                                    {members.map(m => (
                                        <div key={m.id} className="flex items-center justify-between text-sm">
                                            <div className="flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-700">
                                                    {(m.display_name || m.email)[0].toUpperCase()}
                                                </div>
                                                <span className="text-gray-900">{m.display_name || m.email.split('@')[0]}</span>
                                                {m.id === user?.id && <span className="text-xs text-gray-400">(You)</span>}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${m.id === currentBoard?.owner_id
                                                    ? 'bg-purple-100 text-purple-700'
                                                    : 'bg-green-50 text-green-600'
                                                    }`}>
                                                    {m.id === currentBoard?.owner_id ? 'Owner' : 'Active'}
                                                </span>

                                                {/* Only show trash if: We are owner, AND target is not us */}
                                                {isOwner && m.id !== user.id && (
                                                    <button
                                                        onClick={() => handleRemoveMember(m.id)}
                                                        className="text-gray-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors"
                                                        title="Remove Member"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {invitations.map(inv => (
                                        <div key={inv.id} className="flex items-center justify-between text-sm opacity-75">
                                            <div className="flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-400 border border-dashed border-gray-300">
                                                    ?
                                                </div>
                                                <span className="text-gray-500">{inv.email}</span>
                                            </div>
                                            <span className="text-amber-600 text-xs bg-amber-50 px-2 py-0.5 rounded-full">Invited</span>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        placeholder="Invite by email..."
                                        className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg"
                                        onKeyDown={async (e) => {
                                            if (e.key === 'Enter' && e.target.value) {
                                                const email = e.target.value;
                                                const { inviteLink } = await inviteByEmail(email);
                                                e.target.value = '';

                                                const subject = encodeURIComponent('Join me on Tenexity Decision Board');
                                                const body = encodeURIComponent(`Hi,\n\nI've invited you to collaborate on our decision board.\n\nClick here to join: ${inviteLink}\n\n`);
                                                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                                            }
                                        }}
                                    />
                                    <button className="px-3 py-2 bg-gray-900 text-white text-sm rounded-lg" onClick={(e) => {
                                        const input = e.target.previousSibling;
                                        if (input.value) {
                                            const email = input.value;
                                            inviteByEmail(email).then(({ inviteLink }) => {
                                                input.value = '';

                                                // Create Mailto link
                                                const subject = encodeURIComponent('Join me on Tenexity Decision Board');
                                                const body = encodeURIComponent(`Hi,\n\nI've invited you to collaborate on our decision board.\n\nClick here to join: ${inviteLink}\n\n`);
                                                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                                            });
                                        }
                                    }}>Invite</button>
                                </div>
                            </div>

                            <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                                <div className="flex items-center gap-2 text-green-800 text-sm font-medium">
                                    <span></span> API Keys Secured
                                </div>
                                <p className="text-xs text-green-700 mt-1">
                                    Claude and OpenAI API keys are now stored securely on the server. No client-side configuration needed.
                                </p>
                            </div>

                            <div className="flex items-center justify-between">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Daily Summary Emails</label>
                                    <p className="text-xs text-gray-500">Receive a daily digest of active topics</p>
                                </div>
                                <button
                                    onClick={() => setEmailNotifications(!emailNotifications)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${emailNotifications ? 'bg-green-600' : 'bg-gray-200'}`}
                                >
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${emailNotifications ? 'translate-x-6' : 'translate-x-1'}`} />
                                </button>
                            </div>

                            <div className="flex flex-col gap-2">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Email Watcher</label>
                                        <p className="text-xs text-gray-500">Monitor inbox for forwarded emails to create topics</p>
                                    </div>
                                    <button
                                        onClick={() => setEmailWatcherEnabled(!emailWatcherEnabled)}
                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${emailWatcherEnabled ? 'bg-green-600' : 'bg-gray-200'}`}
                                    >
                                        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${emailWatcherEnabled ? 'translate-x-6' : 'translate-x-1'}`} />
                                    </button>
                                </div>
                                {emailWatcherEnabled && (
                                    <details className="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                        <summary className="font-medium cursor-pointer text-gray-700 mb-1">How do I use this?</summary>
                                        <ol className="list-decimal pl-4 space-y-1 mt-1">
                                            <li>Forward any decision-making email thread to: <strong className="text-gray-900 select-all">trigger@tenexity.com</strong></li>
                                            <li>Ensure the <strong>Subject Line</strong> clearly states the decision topic.</li>
                                            <li>The body of the email will be used as the description.</li>
                                            <li>The system will automatically create a draft Topic for you to review.</li>
                                        </ol>
                                    </details>
                                )}
                            </div>

                        </div>

                        {/* Danger Zone */}
                        <div className="mt-8 pt-6 border-t border-gray-100">
                            <h3 className="text-sm font-semibold text-red-600 mb-2">Danger Zone</h3>
                            <div className="p-4 bg-red-50 rounded-xl border border-red-100 flex items-center justify-between">
                                {!isOwner ? (
                                    <>
                                        <div>
                                            <div className="font-medium text-red-900 text-sm">Leave Board</div>
                                            <div className="text-xs text-red-700">Relinquish access to this board.</div>
                                        </div>
                                        <button
                                            onClick={handleLeaveBoard}
                                            className="px-3 py-1.5 bg-white border border-red-200 text-red-600 font-medium rounded-lg hover:bg-red-50 text-xs shadow-sm"
                                        >
                                            Leave
                                        </button>
                                    </>
                                ) : (
                                    <div className="w-full text-center">
                                        <div className="font-medium text-red-900 text-sm opacity-50 cursor-not-allowed">Leave Board</div>
                                        <div className="text-xs text-red-700 mt-1">
                                            As the <strong>Board Owner</strong>, you cannot leave the board.
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex gap-2 mt-6">
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                className="flex-1 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save'}
                            </button>
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                        <div className="text-center pb-2 text-xs text-gray-300">
                            v1.1d (Board Management)
                        </div>
                    </div>
                </div >
            );
        };

        // User Profile Popup
        const UserProfilePopup = ({ onClose }) => {
            const { user, userProfile, updateProfile, signOut } = useContext(AuthContext);
            const [displayName, setDisplayName] = useState(userProfile?.displayName || '');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState(null);

            const handleSaveProfile = async () => {
                setSaving(true);
                setMessage(null);
                try {
                    await updateProfile({ displayName });
                    setMessage({ type: 'success', text: 'Profile updated successfully' });
                    setTimeout(() => setMessage(null), 3000);
                } catch (err) {
                    setMessage({ type: 'error', text: 'Failed to update profile' });
                } finally {
                    setSaving(false);
                }
            };

            const handleChangePassword = async () => {
                if (password !== confirmPassword) {
                    setMessage({ type: 'error', text: 'Passwords do not match' });
                    return;
                }
                setSaving(true);
                setMessage(null);
                try {
                    // In a real app we'd call supabase.auth.updateUser({ password })
                    // For now we'll simulate it
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    setMessage({ type: 'success', text: 'Password updated successfully' });
                    setPassword('');
                    setConfirmPassword('');
                } catch (err) {
                    setMessage({ type: 'error', text: 'Failed to update password' });
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="absolute right-0 top-12 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden">
                    <div className="p-4 bg-gray-50 border-b border-gray-100">
                        <div className="flex items-center gap-3 mb-2">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
                                {displayName?.[0]?.toUpperCase() || user.email[0].toUpperCase()}
                            </div>
                            <div className="overflow-hidden">
                                <h3 className="font-medium text-gray-900 truncate">{displayName || 'User'}</h3>
                                <p className="text-xs text-gray-500 truncate">{user.email}</p>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 space-y-4">
                        <div>
                            <label className="block text-xs font-medium text-gray-500 uppercase mb-1">Display Name</label>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={displayName}
                                    onChange={(e) => setDisplayName(e.target.value)}
                                    className="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                />
                                <button
                                    onClick={handleSaveProfile}
                                    disabled={saving}
                                    className="px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded hover:bg-gray-800 disabled:opacity-50"
                                >
                                    Save
                                </button>
                            </div>
                        </div>

                        <div className="pt-4 border-t border-gray-100">
                            <label className="block text-xs font-medium text-gray-500 uppercase mb-2">Change Password</label>
                            <div className="space-y-2">
                                <input
                                    type="password"
                                    placeholder="New Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                />
                                <input
                                    type="password"
                                    placeholder="Confirm Password"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                />
                                <button
                                    onClick={handleChangePassword}
                                    disabled={!password || saving}
                                    className="w-full py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded hover:bg-gray-200 disabled:opacity-50"
                                >
                                    Update Password
                                </button>
                            </div>
                        </div>

                        {message && (
                            <div className={`p-2 rounded text-xs ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="pt-2 border-t border-gray-100">
                            <button
                                onClick={signOut}
                                className="w-full py-2 text-red-600 text-sm font-medium hover:bg-red-50 rounded flex items-center justify-center gap-2"
                            >
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // TODO PROVIDER (Shared Context)
        // ============================================
        const TodoProvider = ({ children, boards }) => {
            const [todos, setTodos] = useState(() => {
                const saved = localStorage.getItem('tenexity-todos');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('tenexity-todos', JSON.stringify(todos));
            }, [todos]);

            const addTodo = ({ text, boardId, boardName, topicId = null, topicTitle = null, dueDate = null }) => {
                if (!text.trim()) return;
                const todo = {
                    id: generateId(),
                    text: text.trim(),
                    completed: false,
                    boardId,
                    boardName: boardName || 'Unknown Board',
                    topicId,
                    topicTitle: topicTitle || null,
                    dueDate: dueDate || null,
                    createdAt: new Date().toISOString()
                };
                setTodos(prev => [...prev, todo]);
            };

            const toggleTodo = (id) => {
                setTodos(todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const updateTodo = (id, updates) => {
                setTodos(todos.map(t => t.id === id ? { ...t, ...updates } : t));
            };

            const deleteTodo = (id) => {
                setTodos(todos.filter(t => t.id !== id));
            };

            return (
                <TodoContext.Provider value={{ todos, addTodo, toggleTodo, deleteTodo, updateTodo }}>
                    {children}
                </TodoContext.Provider>
            );
        };

        // ============================================
        // TODO HUB (Updated with Board  Topic Grouping)
        // ============================================
        const TodoHub = ({ boards, currentBoardId }) => {
            const { todos, addTodo, toggleTodo, deleteTodo } = useContext(TodoContext);
            const [newTodo, setNewTodo] = useState('');
            const [selectedBoardId, setSelectedBoardId] = useState(currentBoardId);

            const handleAddTodo = (e) => {
                e.preventDefault();
                if (!newTodo.trim()) return;
                const board = boards.find(b => b.id === selectedBoardId);
                addTodo({
                    text: newTodo.trim(),
                    boardId: selectedBoardId,
                    boardName: board?.name || 'Unknown Board',
                    topicId: null,
                    topicTitle: null
                });
                setNewTodo('');
            };

            // Group todos by board, then by topic
            const groupedTodos = todos.reduce((acc, todo) => {
                const boardId = todo.boardId || 'unassigned';
                const topicId = todo.topicId || 'general';
                if (!acc[boardId]) acc[boardId] = {};
                if (!acc[boardId][topicId]) acc[boardId][topicId] = [];
                acc[boardId][topicId].push(todo);
                return acc;
            }, {});

            const getBoardName = (boardId) => {
                if (boardId === 'unassigned') return 'Unassigned';
                const board = boards.find(b => b.id === boardId);
                return board?.name || 'Unknown Board';
            };

            const getTopicName = (topicId, boardTodos) => {
                if (topicId === 'general') return 'General';
                // Find a todo with topicTitle
                const todoWithTitle = Object.values(boardTodos).flat().find(t => t.topicId === topicId && t.topicTitle);
                return todoWithTitle?.topicTitle || 'Unknown Topic';
            };

            const incompleteTodos = todos.filter(t => !t.completed);
            const completedTodos = todos.filter(t => t.completed);

            return (
                <div className="space-y-6">
                    {/* Add Todo Form */}
                    <div className="bg-white rounded-xl border border-gray-200 p-4">
                        <form onSubmit={handleAddTodo} className="flex gap-3">
                            <select
                                value={selectedBoardId || ''}
                                onChange={(e) => setSelectedBoardId(e.target.value)}
                                className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-gray-900"
                            >
                                <option value="">Select Board</option>
                                {boards.map(board => (
                                    <option key={board.id} value={board.id}>{board.name}</option>
                                ))}
                            </select>
                            <input
                                type="text"
                                value={newTodo}
                                onChange={(e) => setNewTodo(e.target.value)}
                                placeholder="Add a new todo..."
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            />
                            <button
                                type="submit"
                                className="px-4 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors"
                            >
                                Add
                            </button>
                        </form>
                    </div>

                    {/* Todos grouped by board  topic */}
                    {Object.keys(groupedTodos).length === 0 ? (
                        <div className="bg-white rounded-xl border border-gray-200 p-12 text-center text-gray-500">
                            <svg className="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            <p className="font-medium">No todos yet</p>
                            <p className="text-sm mt-1">Add your first todo above or from within a topic</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {Object.entries(groupedTodos).map(([boardId, topicGroups]) => (
                                <div key={boardId} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                    <div className="p-3 bg-gray-100 border-b border-gray-200">
                                        <h3 className="font-bold text-gray-900 text-sm">{getBoardName(boardId)}</h3>
                                    </div>
                                    <div className="divide-y divide-gray-100">
                                        {Object.entries(topicGroups).map(([topicId, topicTodos]) => (
                                            <div key={topicId}>
                                                <div className="px-4 py-2 bg-gray-50 border-b border-gray-100">
                                                    <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">
                                                        {topicId === 'general' ? ' General' : ` ${getTopicName(topicId, topicGroups)}`}
                                                    </span>
                                                </div>
                                                {topicTodos.map(todo => (
                                                    <div
                                                        key={todo.id}
                                                        className={`px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors ${todo.completed ? 'opacity-60' : ''}`}
                                                    >
                                                        <button
                                                            onClick={() => toggleTodo(todo.id)}
                                                            className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${todo.completed
                                                                ? 'bg-green-500 border-green-500 text-white'
                                                                : 'border-gray-300 hover:border-gray-400'
                                                                }`}
                                                        >
                                                            {todo.completed && (
                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                                </svg>
                                                            )}
                                                        </button>
                                                        <span className={`flex-1 text-sm ${todo.completed ? 'line-through text-gray-400' : 'text-gray-700'}`}>
                                                            {todo.text}
                                                        </span>
                                                        <button
                                                            onClick={() => deleteTodo(todo.id)}
                                                            className="p-1 text-gray-400 hover:text-red-500 transition-colors"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Summary */}
                    {todos.length > 0 && (
                        <div className="text-center text-sm text-gray-500">
                            {incompleteTodos.length} remaining, {completedTodos.length} completed
                        </div>
                    )}
                </div>
            );
        };

        // ============================================
        // QUICK TODO INPUT (For use inside Topic Detail)
        // ============================================
        const QuickTodoInput = ({ boardId, boardName, topicId, topicTitle }) => {
            const { addTodo, toggleTodo, updateTodo, deleteTodo, todos } = useContext(TodoContext);
            const [text, setText] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [isExpanded, setIsExpanded] = useState(true);
            const [editingId, setEditingId] = useState(null);
            const [editText, setEditText] = useState('');
            const [editDate, setEditDate] = useState('');

            // Get todos for this specific topic (both completed and incomplete to show history if desired, or filter)
            // Showing all for this topic so users can verify they checked it off
            const topicTodos = todos.filter(t => t.topicId === topicId);
            const activeCount = topicTodos.filter(t => !t.completed).length;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                addTodo({
                    text: text.trim(),
                    boardId,
                    boardName,
                    topicId,
                    topicTitle,
                    dueDate
                });
                setText('');
                setDueDate('');
            };

            const startEditing = (todo) => {
                setEditingId(todo.id);
                setEditText(todo.text);
                setEditDate(todo.dueDate || '');
            };

            const saveEdit = (id) => {
                if (!editText.trim()) return;
                updateTodo(id, { text: editText.trim(), dueDate: editDate });
                setEditingId(null);
            };

            return (
                <div className="bg-amber-50 rounded-xl border border-amber-200 overflow-hidden mb-6">
                    <div
                        onClick={() => setIsExpanded(!isExpanded)}
                        className="w-full px-4 py-3 flex items-center justify-between hover:bg-amber-100 transition-colors cursor-pointer"
                    >
                        <div className="flex items-center gap-2">
                            <svg className="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            <span className="font-medium text-amber-800">Tasks & Action Items</span>
                            {activeCount > 0 && (
                                <span className="px-2 py-0.5 text-xs font-medium bg-amber-200 text-amber-800 rounded-full">
                                    {activeCount}
                                </span>
                            )}
                        </div>
                        <svg className={`w-5 h-5 text-amber-600 transition-transform ${isExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    {isExpanded && (
                        <div className="px-4 pb-4 space-y-4 border-t border-amber-100 pt-4">
                            {/* Existing todos for this topic */}
                            {topicTodos.length > 0 && (
                                <div className="space-y-2">
                                    {topicTodos.map(todo => (
                                        <div key={todo.id} className="flex items-start gap-3 text-sm group">
                                            <input
                                                type="checkbox"
                                                checked={todo.completed}
                                                onChange={() => toggleTodo(todo.id)}
                                                className="mt-1 w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500 cursor-pointer"
                                            />
                                            <div className="flex-1">
                                                {editingId === todo.id ? (
                                                    <div className="flex gap-2 items-start">
                                                        <div className="flex-1 space-y-2">
                                                            <input
                                                                type="text"
                                                                value={editText}
                                                                onChange={(e) => setEditText(e.target.value)}
                                                                className="w-full px-2 py-1 text-sm border border-amber-300 rounded focus:ring-1 focus:ring-amber-500"
                                                                autoFocus
                                                            />
                                                            <input
                                                                type="date"
                                                                value={editDate}
                                                                onChange={(e) => setEditDate(e.target.value)}
                                                                className="px-2 py-1 text-xs border border-amber-300 rounded text-gray-600"
                                                            />
                                                        </div>
                                                        <div className="flex flex-col gap-1">
                                                            <button onClick={() => saveEdit(todo.id)} className="p-1 text-green-600 hover:bg-green-50 rounded"></button>
                                                            <button onClick={() => setEditingId(null)} className="p-1 text-red-600 hover:bg-red-50 rounded"></button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-between items-start group">
                                                        <div className={`cursor-pointer ${todo.completed ? 'opacity-50 line-through' : ''}`} onClick={() => startEditing(todo)}>
                                                            <div className="text-amber-900">{todo.text}</div>
                                                            {todo.dueDate && (
                                                                <div className={`text-xs mt-0.5 ${new Date(todo.dueDate) < new Date() && !todo.completed ? 'text-red-500 font-medium' : 'text-amber-600/70'}`}>
                                                                     {new Date(todo.dueDate).toLocaleDateString()}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={() => startEditing(todo)} className="p-1 text-amber-600 hover:bg-amber-100 rounded" title="Edit">
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                                            </button>
                                                            <button onClick={() => deleteTodo(todo.id)} className="p-1 text-amber-600 hover:text-red-600 hover:bg-red-50 rounded" title="Delete">
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {/* Add new todo */}
                            <form onSubmit={handleSubmit} className="flex gap-2 items-start">
                                <div className="flex-1 flex gap-2">
                                    <input
                                        type="text"
                                        value={text}
                                        onChange={(e) => setText(e.target.value)}
                                        placeholder="Add a task..."
                                        className="flex-1 px-3 py-2 text-sm border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent bg-white w-full"
                                    />
                                    <input
                                        type="date"
                                        value={dueDate}
                                        onChange={(e) => setDueDate(e.target.value)}
                                        className="px-2 py-2 text-sm border border-amber-300 rounded-lg bg-white text-gray-600 w-32"
                                        title="Due Date"
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="px-4 py-2 text-sm font-medium bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors shadow-sm"
                                >
                                    Add
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        // ============================================
        // KANBAN BOARD
        // ============================================
        const KanbanBoard = ({ topics, onTopicClick, onUpdateStatus }) => {
            const columns = [
                { id: 'suggested', title: 'Suggested', color: 'bg-orange-50 border-orange-200', textColor: 'text-orange-800' },
                { id: 'open', title: 'Open', color: 'bg-blue-50 border-blue-200', textColor: 'text-blue-800' },
                { id: 'pending', title: 'Pending', color: 'bg-purple-50 border-purple-200', textColor: 'text-purple-800' },
                { id: 'decided', title: 'Decided', color: 'bg-green-50 border-green-200', textColor: 'text-green-800' }
            ];

            return (
                <div className="flex gap-4 h-[calc(100vh-200px)] overflow-x-auto pb-4">
                    {columns.map(col => {
                        const colTopics = topics.filter(t => t.status === col.id);
                        return (
                            <div
                                key={col.id}
                                className="w-80 flex-shrink-0 flex flex-col bg-gray-50 rounded-xl border border-gray-200"
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={(e) => {
                                    e.preventDefault();
                                    const topicId = e.dataTransfer.getData('text/plain');
                                    if (topicId) onUpdateStatus(topicId, col.id);
                                }}
                            >
                                <div className={`p-3 border-b border-gray-200 rounded-t-xl font-semibold flex justify-between items-center ${col.color} ${col.textColor}`}>
                                    <span>{col.title}</span>
                                    <span className="text-xs opacity-70 bg-white px-2 py-0.5 rounded-full">
                                        {colTopics.length}
                                    </span>
                                </div>
                                <div className="p-3 flex-1 overflow-y-auto space-y-3 min-h-[100px]">
                                    {colTopics.map(topic => (
                                        <div
                                            key={topic.id}
                                            draggable
                                            onDragStart={(e) => {
                                                e.dataTransfer.setData('text/plain', topic.id);
                                                e.dataTransfer.effectAllowed = 'move';
                                            }}
                                            onClick={() => onTopicClick(topic.id)}
                                            className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:shadow-md transition-shadow group relative active:cursor-grabbing"
                                        >
                                            <h4 className="font-medium text-gray-900 text-sm mb-1">{topic.title}</h4>
                                            <div className="flex items-center justify-between text-xs text-gray-500">
                                                <span>{formatDate(topic.created_at)}</span>
                                                {topic.due_date && (
                                                    <span className="text-orange-600 font-medium">
                                                        Due: {new Date(topic.due_date).toLocaleDateString()}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Quick Actions (Hover) */}
                                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white rounded shadow-sm">
                                                {col.id !== 'decided' && (
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); onUpdateStatus(topic.id, 'decided'); }}
                                                        className="p-1 hover:bg-green-50 text-green-600 rounded" title="Move to Decided"
                                                    >
                                                        
                                                    </button>
                                                )}
                                                {col.id === 'suggested' && (
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); onUpdateStatus(topic.id, 'open'); }}
                                                        className="p-1 hover:bg-blue-50 text-blue-600 rounded" title="Approve / Move to Open"
                                                    >
                                                        
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // View Toggle Component
        const ViewToggle = ({ viewMode, setViewMode }) => {
            return (
                <div className="flex bg-gray-100 rounded-lg p-1">
                    <button
                        onClick={() => setViewMode('list')}
                        className={`p-2 rounded-md transition-all ${viewMode === 'list' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'}`}
                        title="List View"
                    >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <button
                        onClick={() => setViewMode('kanban')}
                        className={`p-2 rounded-md transition-all ${viewMode === 'kanban' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'}`}
                        title="Kanban View"
                    >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>
                    </button>
                </div>
            );
        };

        // ============================================
        // MAIN DASHBOARD
        // ============================================
        // ============================================
        // SUGGESTIONS VIEW
        // ============================================
        const SuggestionsView = () => {
            const { user } = useContext(AuthContext);
            const [suggestions, setSuggestions] = useState(() => {
                const saved = localStorage.getItem('tenexity-suggestions');
                return saved ? JSON.parse(saved) : [];
            });
            const [newSuggestion, setNewSuggestion] = useState('');

            useEffect(() => {
                localStorage.setItem('tenexity-suggestions', JSON.stringify(suggestions));
            }, [suggestions]);

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newSuggestion.trim()) return;
                const suggestion = {
                    id: Date.now().toString(),
                    text: newSuggestion.trim(),
                    votes: 0,
                    author: user.email,
                    createdAt: new Date().toISOString(),
                    voters: []
                };
                setSuggestions([suggestion, ...suggestions]);
                setNewSuggestion('');
            };

            const toggleVote = (id) => {
                setSuggestions(suggestions.map(s => {
                    if (s.id === id) {
                        const hasVoted = s.voters.includes(user.email);
                        return {
                            ...s,
                            votes: hasVoted ? s.votes - 1 : s.votes + 1,
                            voters: hasVoted ? s.voters.filter(v => v !== user.email) : [...s.voters, user.email]
                        };
                    }
                    return s;
                }));
            };

            return (
                <div className="max-w-3xl mx-auto space-y-6">
                    <div className="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-xl p-8 text-white shadow-lg">
                        <h2 className="text-2xl font-bold mb-2">Suggest Updates</h2>
                        <p className="opacity-90 max-w-xl">
                            Help us build the Decision Engine. Share your ideas for new features or improvements.
                            All suggestions are public to the team.
                        </p>
                    </div>

                    <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                        <form onSubmit={handleAdd} className="flex gap-4">
                            <input
                                type="text"
                                value={newSuggestion}
                                onChange={(e) => setNewSuggestion(e.target.value)}
                                placeholder="I wish I could..."
                                className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent"
                            />
                            <button
                                type="submit"
                                disabled={!newSuggestion.trim()}
                                className="px-6 py-2 bg-violet-600 text-white font-medium rounded-lg hover:bg-violet-700 disabled:opacity-50 transition-colors"
                            >
                                Post Idea
                            </button>
                        </form>
                    </div>

                    <div className="space-y-4">
                        {suggestions.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                                <p>No suggestions yet. Be the first!</p>
                            </div>
                        ) : (
                            suggestions.sort((a, b) => b.votes - a.votes).map(suggestion => (
                                <div key={suggestion.id} className="bg-white rounded-xl border border-gray-200 p-4 flex gap-4 transition-all hover:shadow-md">
                                    <button
                                        onClick={() => toggleVote(suggestion.id)}
                                        className={`flex flex-col items-center justify-center w-12 h-14 rounded-lg border transition-colors ${suggestion.voters.includes(user.email)
                                            ? 'bg-violet-50 border-violet-200 text-violet-600'
                                            : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-300'
                                            }`}
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 15l7-7 7 7" />
                                        </svg>
                                        <span className="font-bold text-sm">{suggestion.votes}</span>
                                    </button>
                                    <div className="flex-1 py-1">
                                        <p className="text-gray-900 font-medium text-lg mb-1">{suggestion.text}</p>
                                        <div className="flex items-center gap-2 text-xs text-gray-500">
                                            <span>{suggestion.author.split('@')[0]}</span>
                                            <span></span>
                                            <span>{new Date(suggestion.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const { user, userProfile, boards, currentBoardId, members, invitations } = useContext(AuthContext);
            const { topics, boardMembers, loading, addTopic, updateTopic, deleteTopic, addContribution, deleteContribution } = useContext(BoardContext);

            const [selectedTopicId, setSelectedTopicId] = useState(null);
            const [showTopicForm, setShowTopicForm] = useState(false);
            const [sortBy, setSortBy] = useState('date');
            const [showSettings, setShowSettings] = useState(false);
            const [showInvite, setShowInvite] = useState(false);
            const [showProfilePopup, setShowProfilePopup] = useState(false);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [editingTitleId, setEditingTitleId] = useState(null);
            const [tempTitle, setTempTitle] = useState('');
            const [viewMode, setViewMode] = useState('list'); // 'list' or 'kanban'
            const [activeTab, setActiveTab] = useState('dashboard'); // 'dashboard', 'board', 'archive', 'todo'

            const currentBoard = boards.find(b => b.id === currentBoardId);
            const selectedTopic = topics.find(t => t.id === selectedTopicId);

            const sortedTopics = [...topics].sort((a, b) => {
                if (sortBy === 'date') {
                    return new Date(b.created_at) - new Date(a.created_at);
                } else {
                    return a.title.localeCompare(b.title);
                }
            });

            const suggestedTopics = sortedTopics.filter(t => t.status === 'suggested');
            const activeTopics = sortedTopics.filter(t => t.status !== 'suggested' && t.status !== 'decided');
            const archivedTopics = sortedTopics.filter(t => t.status === 'decided');

            const handleApproveTopic = async (topicId) => {
                await updateTopic(topicId, { status: 'open' });
            };

            const handleAddTopic = async (topicData) => {
                await addTopic(topicData);
                setShowTopicForm(false);
            };

            const handleUpdateTitle = async (topicId) => {
                if (!tempTitle.trim()) return;
                await updateTopic(topicId, { title: tempTitle.trim() });
                setEditingTitleId(null);
            };

            const handleUpdateStatus = async (status, topicId = null) => {
                const idToUpdate = topicId || selectedTopicId;
                await updateTopic(idToUpdate, { status });
            };

            const handleUpdateRank = async (rank, topicId = null) => {
                const idToUpdate = topicId || selectedTopicId;
                await updateTopic(idToUpdate, { rank });
            };

            const handleDeleteTopic = async () => {
                if (confirm('Are you sure you want to delete this topic?')) {
                    await deleteTopic(selectedTopicId);
                    setSelectedTopicId(null);
                }
            };

            const handleAddContribution = async (contribution) => {
                await addContribution(selectedTopicId, contribution);
            };

            if (loading) {
                return <Spinner />;
            }

            return (
                <div className="min-h-screen" style={{ background: 'var(--background)' }}>
                    {/* Header */}
                    <header className="card mobile-header sticky top-0 z-40 rounded-none border-x-0 border-t-0 bg-white" style={{ background: 'white' }}>
                        <div className="max-w-7xl mx-auto px-4 md:px-6 py-3 md:py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3 md:gap-4">
                                    {/* Mobile back button (shown when topic is selected) */}
                                    {selectedTopic && (
                                        <button
                                            onClick={() => setSelectedTopicId(null)}
                                            className="mobile-back-btn"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                            </svg>
                                            Back
                                        </button>
                                    )}
                                    <TenexityLogo size={32} className="md:w-10 md:h-10" />
                                    <div>
                                        <h1 className="text-base md:text-xl font-bold" style={{ color: 'var(--foreground)' }}>
                                            Decision Engine
                                        </h1>
                                        <p className="text-xs md:text-sm desktop-only" style={{ color: 'var(--muted-foreground)' }}>
                                            {currentBoard?.name || 'My Board'}  {boardMembers.length} member{boardMembers.length !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                </div>
                                <div className="hidden md:flex items-center text-sm text-gray-500 ml-4 pl-4 border-l border-gray-200">
                                    <span className="flex items-center gap-1">
                                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                        {boardMembers.length} members
                                    </span>
                                </div>
                                <div className="flex items-center gap-3">
                                    {activeTab === 'board' && <ViewToggle viewMode={viewMode} setViewMode={setViewMode} />}

                                    <button
                                        onClick={() => setShowInvite(true)}
                                        className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-[#EBCB8B] text-gray-900 text-sm font-medium rounded-lg hover:bg-[#EBCB8B]/90 transition-colors shadow-sm"
                                    >
                                        <span>+ Invite</span>
                                    </button>

                                    <div className="relative">
                                        <button
                                            onClick={() => setShowProfilePopup(!showProfilePopup)}
                                            className="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors"
                                        >
                                            <div className="w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center font-medium shadow-sm">
                                                {userProfile?.displayName?.[0]?.toUpperCase() || user.email[0].toUpperCase()}
                                            </div>
                                            <span className="hidden sm:block text-sm font-medium text-gray-700">
                                                {userProfile?.displayName || 'Developer'}
                                            </span>
                                        </button>

                                        {showProfilePopup && (
                                            <UserProfilePopup onClose={() => setShowProfilePopup(false)} />
                                        )}
                                    </div>

                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Tab Navigation - Desktop only */}
                    <div className="top-tabs card rounded-none border-x-0 sticky top-[64px] z-30" style={{ background: 'white', top: '64px' }}>
                        <div className="max-w-7xl mx-auto px-6">
                            <nav className="flex gap-1">
                                {[
                                    { id: 'dashboard', label: 'Dashboard', count: null },
                                    { id: 'board', label: 'Topics', count: null },
                                    { id: 'archive', label: 'Archive', count: archivedTopics.length },
                                    { id: 'todo', label: 'Todo', count: null },
                                    { id: 'suggest', label: 'Suggest', count: null }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`px-4 py-3 text-sm font-medium rounded-t-lg transition-all ${activeTab === tab.id ? '' : 'hover:bg-opacity-50'
                                            }`}
                                        style={{
                                            background: activeTab === tab.id ? 'var(--background)' : 'transparent',
                                            color: activeTab === tab.id ? 'var(--primary)' : 'var(--muted-foreground)',
                                            borderBottom: activeTab === tab.id ? '2px solid var(--primary)' : '2px solid transparent'
                                        }}
                                    >
                                        {tab.label} {tab.count !== null && `(${tab.count})`}
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </div>

                    {/* Main content */}
                    <div className="mobile-container max-w-7xl mx-auto px-4 md:px-6 py-4 md:py-6">
                        {/* Dashboard Tab Content */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8">
                                {(() => {
                                    // Logic for categorize topics
                                    const myTurnTopics = [];
                                    const waitingTopics = [];

                                    activeTopics.filter(t => t.status !== 'decided').forEach(topic => {
                                        const sortedContributions = (topic.contributions || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                                        const lastContribution = sortedContributions[0];

                                        // Robust Date Handling
                                        let lastActionTime = lastContribution ? new Date(lastContribution.created_at) : new Date(topic.created_at);
                                        if (isNaN(lastActionTime.getTime())) lastActionTime = new Date(); // Fallback if data corruption

                                        const lastActionUser = lastContribution ? (lastContribution.user_id || lastContribution.author) : topic.created_by;

                                        const isLastActionMe = lastActionUser === user.id;
                                        const hoursDiff = (new Date() - lastActionTime) / (1000 * 60 * 60);
                                        const isIdle = hoursDiff > 48;

                                        // Refined Logic based on User Request:
                                        // "My Turn" (Top Section): 
                                        // Strictly if someone else spoke last.

                                        // "Waiting / Other's Turn" (Bottom Section):
                                        // Strictly if I spoke last.

                                        if (!isLastActionMe) {
                                            myTurnTopics.push({ ...topic, isIdle, lastActionTime });
                                        } else {
                                            waitingTopics.push({ ...topic, isIdle, lastActionTime });
                                        }
                                    });

                                    const renderTopicCard = (topic, labelOverride = null) => (
                                        <div key={topic.id} className="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-md transition-shadow">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex items-center gap-2">
                                                    {labelOverride ? (
                                                        <span className={`text-xs font-bold px-2 py-0.5 rounded border ${labelOverride === 'Idle (>48h)' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-blue-50 text-blue-700 border-blue-100'
                                                            }`}>
                                                            {labelOverride}
                                                        </span>
                                                    ) : (
                                                        <span className="text-xs font-bold px-2 py-0.5 rounded border bg-gray-50 text-gray-600 border-gray-200">
                                                            Waiting
                                                        </span>
                                                    )}
                                                    {topic.rank && (
                                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${topic.rank === 'A' ? 'bg-red-50 text-red-700 border-red-100' :
                                                            topic.rank === 'B' ? 'bg-yellow-50 text-yellow-700 border-yellow-100' :
                                                                'bg-green-50 text-green-700 border-green-100'
                                                            }`}>{topic.rank}</span>
                                                    )}
                                                </div>
                                                <StatusBadge status={topic.status} />
                                            </div>

                                            <h3 className="text-lg font-bold text-gray-900 mb-2 card-title">{topic.title}</h3>
                                            <p className="text-sm text-gray-500 mb-4 line-clamp-2">{topic.description || 'No description provided.'}</p>

                                            <div className="flex justify-between items-center text-xs text-gray-400 mt-auto">
                                                <span>Last: {formatDate(topic.lastActionTime)}</span>
                                                <button
                                                    onClick={() => {
                                                        setActiveTab('board');
                                                        setSelectedTopicId(topic.id);
                                                    }}
                                                    className="text-blue-600 font-medium hover:underline"
                                                >
                                                    Open 
                                                </button>
                                            </div>
                                        </div>
                                    );

                                    return (
                                        <>
                                            {/* Section 1: My Turn */}
                                            <details open className="group">
                                                <summary className="flex items-center gap-2 font-bold text-xl text-gray-800 cursor-pointer mb-4 list-none">
                                                    <span className="transform group-open:rotate-90 transition-transform inline-block"></span>
                                                    My Turn
                                                    <span className="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded-full">{myTurnTopics.length}</span>
                                                </summary>

                                                {myTurnTopics.length > 0 ? (
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 pl-4">
                                                        {myTurnTopics.map(topic => renderTopicCard(topic, topic.isIdle ? 'Idle (>48h)' : 'Your Turn'))}
                                                    </div>
                                                ) : (
                                                    <div className="text-gray-400 italic mb-8 pl-4">Great job! No pending actions for you.</div>
                                                )}
                                            </details>

                                            {/* Section 2: Waiting / Their Turn */}
                                            <details open className="group">
                                                <summary className="flex items-center gap-2 font-bold text-xl text-gray-500 cursor-pointer mb-4 list-none">
                                                    <span className="transform group-open:rotate-90 transition-transform inline-block"></span>
                                                    Waiting for Others
                                                    <span className="bg-gray-100 text-gray-600 text-sm font-medium px-2.5 py-0.5 rounded-full">
                                                        {waitingTopics.length + (invitations ? invitations.length : 0)}
                                                    </span>
                                                </summary>

                                                <div className="space-y-6 pl-4">
                                                    {/* Pending Invitations Warning */}
                                                    {invitations && invitations.length > 0 && (
                                                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                                            <h4 className="text-amber-800 font-medium mb-2 flex items-center gap-2">
                                                                <span className="animate-pulse"></span> Waiting for Team to Join
                                                            </h4>
                                                            <div className="space-y-2">
                                                                {invitations.map(inv => (
                                                                    <div key={inv.id} className="flex items-center justify-between bg-white bg-opacity-60 p-2 rounded">
                                                                        <span className="text-amber-900 text-sm">Invitation sent to <strong>{inv.email}</strong></span>
                                                                        <span className="text-xs text-amber-700 font-mono bg-amber-100 px-2 py-1 rounded">Pending</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* No Members Warning */}
                                                    {members && members.length <= 1 && (!invitations || invitations.length === 0) && (
                                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between">
                                                            <div>
                                                                <h4 className="text-blue-800 font-medium">Flying Solo? </h4>
                                                                <p className="text-blue-600 text-sm">Invite your co-founder to start collaborating on decisions.</p>
                                                            </div>
                                                            <button
                                                                onClick={() => setShowSettings(true)}
                                                                className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700"
                                                            >
                                                                Invite Team
                                                            </button>
                                                        </div>
                                                    )}

                                                    {/* Cards */}
                                                    {waitingTopics.length > 0 ? (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                            {waitingTopics.map(topic => renderTopicCard(topic, null))}
                                                        </div>
                                                    ) : (
                                                        (!invitations || invitations.length === 0) && members && members.length > 1 && (
                                                            <div className="text-gray-400 italic">No topics currently waiting on others.</div>
                                                        )
                                                    )}
                                                </div>
                                            </details>
                                        </>
                                    );
                                })()}
                            </div>
                        )}

                        {/* Board Tab Content */}
                        {activeTab === 'board' && (
                            <div className="flex gap-6">
                                {/* Main View Area */}
                                {viewMode === 'kanban' ? (
                                    <div className="flex-1 min-w-0 overflow-x-hidden">
                                        <KanbanBoard
                                            topics={topics}
                                            onTopicClick={setSelectedTopicId}
                                            onUpdateStatus={(id, status) => handleUpdateStatus(status, id)}
                                        />
                                    </div>
                                ) : (
                                    <div className="flex gap-6 w-full">
                                        {/* Sidebar Panel - Topic List */}
                                        <div className={`sidebar-panel flex-shrink-0 transition-all duration-300 flex flex-col ${isSidebarCollapsed ? 'w-16 md:w-20' : 'w-full md:w-80'}`}>
                                            <div className="card overflow-hidden h-[calc(100vh-14rem)] flex flex-col">
                                                <div className="p-4 bg-white border-b border-gray-100 flex justify-between items-center">
                                                    {!isSidebarCollapsed && (
                                                        <div>
                                                            <h2 className="font-semibold text-gray-900">Topics</h2>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                <button onClick={() => setSortBy('date')} className={`text-xs px-2 py-0.5 rounded ${sortBy === 'date' ? 'bg-gray-200 text-gray-800' : 'text-gray-500 hover:bg-gray-100'}`}>Newest</button>
                                                                <button onClick={() => setSortBy('alpha')} className={`text-xs px-2 py-0.5 rounded ${sortBy === 'alpha' ? 'bg-gray-200 text-gray-800' : 'text-gray-500 hover:bg-gray-100'}`}>A-Z</button>
                                                            </div>
                                                        </div>
                                                    )}
                                                    <div className={`flex items-center gap-2 ${isSidebarCollapsed ? 'flex-col w-full' : ''}`}>
                                                        <button
                                                            onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)}
                                                            className="p-1.5 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
                                                            title={isSidebarCollapsed ? "Expand Sidebar" : "Collapse Sidebar"}
                                                        >
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2" strokeWidth="2" />
                                                                <line x1="9" x2="9" y1="3" y2="21" strokeWidth="2" />
                                                            </svg>
                                                        </button>
                                                        {!isSidebarCollapsed && (
                                                            <button
                                                                onClick={() => setShowTopicForm(true)}
                                                                className="w-8 h-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-md transition-colors"
                                                                title="Create New Topic"
                                                            >
                                                                <span className="text-xl font-medium leading-none mb-0.5">+</span>
                                                            </button>
                                                        )}
                                                        {isSidebarCollapsed && (
                                                            <button
                                                                onClick={() => setShowTopicForm(true)}
                                                                className="w-8 h-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-md transition-colors mt-2"
                                                                title="Create New Topic"
                                                            >
                                                                <span className="text-xl font-medium leading-none mb-0.5">+</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="flex-1 overflow-y-auto p-2">
                                                    {isSidebarCollapsed ? (
                                                        <div className="space-y-4 pt-2">
                                                            {/* Collapsed List - Numbers only */}
                                                            {activeTopics.map((topic, index) => (
                                                                <div
                                                                    key={topic.id}
                                                                    onClick={() => setSelectedTopicId(topic.id)}
                                                                    className={`w-10 h-10 mx-auto mb-2 rounded-full flex items-center justify-center cursor-pointer ${selectedTopicId === topic.id ? 'bg-blue-600 text-white shadow-md' : 'bg-blue-100 text-blue-800 hover:bg-blue-200'}`}
                                                                    title={topic.title}
                                                                >
                                                                    <span className="font-bold text-sm">{(topic.rank || '').toUpperCase() || (index + 1)}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="space-y-6">
                                                            {/* Full List */}
                                                            {suggestedTopics.length > 0 && (
                                                                <div className="mb-4">
                                                                    <h3 className="text-xs font-semibold uppercase tracking-wider mb-2 px-2 text-gray-500">Inbox ({suggestedTopics.length})</h3>
                                                                    {suggestedTopics.map(topic => (
                                                                        <div key={topic.id} onClick={() => setSelectedTopicId(topic.id)} className="p-3 rounded-lg cursor-pointer hover:bg-gray-50 border border-transparent hover:border-gray-200">
                                                                            <span className="text-xs font-bold text-orange-600 block mb-1">AI Draft</span>
                                                                            <h4 className="font-medium text-sm truncate">{topic.title}</h4>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}

                                                            {showTopicForm && (
                                                                <div className="p-4 mb-4 bg-gray-50 rounded-lg border border-gray-200">
                                                                    <TopicForm onSubmit={handleAddTopic} onCancel={() => setShowTopicForm(false)} />
                                                                </div>
                                                            )}

                                                            {/* Grouped Topics by Rank */}
                                                            {['A', 'B', 'C', 'Unranked'].map(rankGroup => {
                                                                const groupTopics = activeTopics.filter(t => {
                                                                    if (rankGroup === 'Unranked') return !t.rank;
                                                                    return (t.rank || '').toUpperCase() === rankGroup;
                                                                });

                                                                if (groupTopics.length === 0) return null;

                                                                return (
                                                                    <div key={rankGroup}>
                                                                        <h3 className="text-xs font-bold uppercase tracking-wider mb-2 px-2 text-gray-400 flex items-center gap-2">
                                                                            {rankGroup === 'Unranked' ? 'No Rank' : `Rank ${rankGroup}`}
                                                                            <span className="bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded-full text-[10px]">{groupTopics.length}</span>
                                                                        </h3>
                                                                        <div className="space-y-2">
                                                                            {groupTopics.map(topic => (
                                                                                <div
                                                                                    key={topic.id}
                                                                                    onClick={() => setSelectedTopicId(topic.id)}
                                                                                    className={`p-4 rounded-lg cursor-pointer transition-all card-hover border ${selectedTopicId === topic.id ? 'border-blue-200 bg-blue-50/50' : 'border-gray-100 bg-white'}`}
                                                                                >
                                                                                    <div className="flex justify-between items-start mb-1">
                                                                                        <h3 className={`font-medium truncate flex-1 ${selectedTopicId === topic.id ? 'text-blue-700' : 'text-gray-900'}`}>{topic.title}</h3>
                                                                                        {topic.rank && <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ml-2 ${topic.rank === 'A' ? 'bg-red-50 text-red-700 border-red-100' :
                                                                                            topic.rank === 'B' ? 'bg-yellow-50 text-yellow-700 border-yellow-100' :
                                                                                                'bg-green-50 text-green-700 border-green-100'
                                                                                            }`}>{topic.rank}</span>}
                                                                                    </div>
                                                                                    <p className="text-xs text-gray-500 mt-1">{formatDate(topic.created_at)}</p>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right panel - Topic detail (full screen on mobile) */}
                                        <div className={`detail-panel flex-1 min-w-0 ${!selectedTopic ? 'mobile-hidden' : ''}`}>
                                            {selectedTopic ? (
                                                <div className="space-y-4 md:space-y-6 p-4 md:p-0">
                                                    <div className="card p-6 space-y-8">
                                                        {selectedTopic.status === 'suggested' && (
                                                            <div className="mb-6 p-4 bg-orange-50 border border-orange-100 rounded-lg flex items-center justify-between">
                                                                <div>
                                                                    <h3 className="font-semibold text-orange-900">AI Suggested Topic</h3>
                                                                    <p className="text-sm text-orange-700">
                                                                        This topic was created from an inbound email. Review and approve it to start discussion.
                                                                    </p>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button
                                                                        onClick={() => handleDeleteTopic()}
                                                                        className="px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors border border-transparent hover:border-red-200"
                                                                    >
                                                                        Reject
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleApproveTopic(selectedTopicId)}
                                                                        className="px-3 py-1.5 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-lg transition-colors shadow-sm"
                                                                    >
                                                                        Approve Topic
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        )}

                                                        <div className="flex items-start justify-between">
                                                            <div>
                                                                {editingTitleId === selectedTopic.id ? (
                                                                    <div className="flex items-center gap-2">
                                                                        <input
                                                                            type="text"
                                                                            value={tempTitle}
                                                                            onChange={(e) => setTempTitle(e.target.value)}
                                                                            className="text-2xl font-bold text-gray-900 border-b-2 border-blue-500 focus:outline-none px-1"
                                                                            autoFocus
                                                                            onKeyDown={(e) => {
                                                                                if (e.key === 'Enter') handleUpdateTitle(selectedTopic.id);
                                                                                if (e.key === 'Escape') setEditingTitleId(null);
                                                                            }}
                                                                            onBlur={() => handleUpdateTitle(selectedTopic.id)}
                                                                        />
                                                                    </div>
                                                                ) : (
                                                                    <div className="flex items-center gap-2 group">
                                                                        <h2 className="text-2xl font-bold text-gray-900">{selectedTopic.title}</h2>
                                                                        <button
                                                                            onClick={() => {
                                                                                setEditingTitleId(selectedTopic.id);
                                                                                setTempTitle(selectedTopic.title);
                                                                            }}
                                                                            className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-blue-500 transition-opacity p-1"
                                                                            title="Edit Title"
                                                                        >
                                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                                            </svg>
                                                                        </button>
                                                                    </div>
                                                                )}
                                                                {selectedTopic.description && (
                                                                    <p className="text-gray-600 mt-2">{selectedTopic.description}</p>
                                                                )}
                                                                <div className="flex items-center gap-4 mt-3 text-sm text-gray-500">
                                                                    <span>Created: {formatDate(selectedTopic.created_at)}</span>
                                                                    {selectedTopic.due_date && (
                                                                        <span className="text-orange-600">
                                                                            Due: {new Date(selectedTopic.due_date).toLocaleDateString()}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <select
                                                                    value={selectedTopic.rank || ''}
                                                                    onChange={(e) => handleUpdateRank(e.target.value)}
                                                                    className="px-3 py-2 border border-blue-200 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold focus:ring-2 focus:ring-blue-500"
                                                                >
                                                                    <option value="">No Rank</option>
                                                                    <option value="A">Rank A</option>
                                                                    <option value="B">Rank B</option>
                                                                    <option value="C">Rank C</option>
                                                                </select>
                                                                <select
                                                                    value={selectedTopic.status}
                                                                    onChange={(e) => handleUpdateStatus(e.target.value)}
                                                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-gray-900"
                                                                >
                                                                    <option value="suggested">Inbox</option>
                                                                    <option value="open">Discussion</option>
                                                                    <option value="pending">Pending</option>
                                                                    <option value="decided">Decided</option>
                                                                </select>
                                                                <button
                                                                    onClick={handleDeleteTopic}
                                                                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                                                                    title="Delete topic"
                                                                >
                                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>


                                                        <AISummary topic={selectedTopic} onSaveAsContribution={handleAddContribution} />

                                                        <QuickTodoInput
                                                            boardId={currentBoardId}
                                                            boardName={currentBoard?.name}
                                                            topicId={selectedTopic.id}
                                                            topicTitle={selectedTopic.title}
                                                        />

                                                        <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                                                            <h3 className="font-semibold text-gray-800 mb-4">Add Your Input</h3>
                                                            <ContributionForm onSubmit={handleAddContribution} />
                                                        </div>

                                                        <div className="space-y-4">
                                                            <h3 className="font-semibold text-gray-800">
                                                                Discussion ({(selectedTopic.contributions || []).length})
                                                            </h3>
                                                            {(selectedTopic.contributions || []).length === 0 ? (
                                                                <div className="bg-gray-50 rounded-lg p-8 text-center text-gray-500">
                                                                    <p>No contributions yet. Be the first to share your input!</p>
                                                                </div>
                                                            ) : (
                                                                (selectedTopic.contributions || []).map(contribution => (
                                                                    <Contribution
                                                                        key={contribution.id}
                                                                        contribution={contribution}
                                                                        topicId={selectedTopic.id}
                                                                        onDelete={(contributionId) => deleteContribution(selectedTopic.id, contributionId)}
                                                                    />
                                                                ))
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="bg-white rounded-xl border border-gray-200 p-12 text-center h-[calc(100vh-14rem)] flex flex-col items-center justify-center">
                                                    <TenexityLogo size={64} className="mx-auto mb-4 opacity-20" />
                                                    <h2 className="text-xl font-semibold text-gray-800 mb-2">Select a Topic</h2>
                                                    <p className="text-gray-500 max-w-sm">Choose a topic from the sidebar or click the + button to create a new one.</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* Modal for Topic Detail in Kanban View (reuse selectedTopic) */}
                                {viewMode === 'kanban' && selectedTopic && (
                                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                        <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
                                            <button
                                                onClick={() => setSelectedTopicId(null)}
                                                className="absolute top-4 right-4 p-2 text-gray-500 hover:bg-gray-100 rounded-full z-10"
                                            >
                                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                            </button>

                                            <div className="p-8 space-y-6">
                                                <div className="flex items-start justify-between">
                                                    <div>
                                                        <h2 className="text-2xl font-bold text-gray-900">{selectedTopic.title}</h2>
                                                        {selectedTopic.description && (
                                                            <p className="text-gray-600 mt-2">{selectedTopic.description}</p>
                                                        )}
                                                        <div className="flex items-center gap-4 mt-3 text-sm text-gray-500">
                                                            <span>Created: {formatDate(selectedTopic.created_at)}</span>
                                                            {selectedTopic.due_date && (
                                                                <span className="text-orange-600">
                                                                    Due: {new Date(selectedTopic.due_date).toLocaleDateString()}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white rounded-xl border border-gray-200 p-6">
                                                    <h3 className="font-semibold text-gray-800 mb-4">Add Your Input</h3>
                                                    <ContributionForm onSubmit={handleAddContribution} />
                                                </div>
                                                <div className="space-y-4">
                                                    <h3 className="font-semibold text-gray-800">
                                                        Discussion ({(selectedTopic.contributions || []).length})
                                                    </h3>
                                                    {(selectedTopic.contributions || []).length === 0 ? (
                                                        <div className="bg-gray-50 rounded-lg p-8 text-center text-gray-500">
                                                            <p>No contributions yet.</p>
                                                        </div>
                                                    ) : (
                                                        (selectedTopic.contributions || []).map(contribution => (
                                                            <Contribution
                                                                key={contribution.id}
                                                                contribution={contribution}
                                                                topicId={selectedTopic.id}
                                                                onDelete={(contributionId) => deleteContribution(selectedTopic.id, contributionId)}
                                                            />
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {activeTab === 'archive' && (
                            <div className="bg-white rounded-xl border border-gray-200">
                                <div className="p-4 border-b border-gray-200">
                                    <h2 className="font-semibold text-gray-800">Archived Decisions</h2>
                                    <p className="text-sm text-gray-500 mt-1">Topics that have been decided and completed</p>
                                </div>
                                {archivedTopics.length === 0 ? (
                                    <div className="p-12 text-center text-gray-500">
                                        <svg className="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                        </svg>
                                        <p className="font-medium">No archived topics yet</p>
                                        <p className="text-sm mt-1">Topics marked as "Decided" will appear here</p>
                                    </div>
                                ) : (
                                    <div className="divide-y divide-gray-100">
                                        {archivedTopics.map(topic => (
                                            <div
                                                key={topic.id}
                                                onClick={() => { setSelectedTopicId(topic.id); setActiveTab('board'); }}
                                                className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                                            >
                                                <div className="flex items-start justify-between gap-4">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-green-600">
                                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                </svg>
                                                            </span>
                                                            <h3 className="font-medium text-gray-900 truncate">{topic.title}</h3>
                                                        </div>
                                                        {topic.description && (
                                                            <p className="text-sm text-gray-500 mt-1 line-clamp-2">{topic.description}</p>
                                                        )}
                                                        <div className="flex items-center gap-4 mt-2 text-xs text-gray-400">
                                                            <span>Created: {formatDate(topic.created_at)}</span>
                                                            <span>{(topic.contributions || []).length} contributions</span>
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); handleUpdateStatus('open', topic.id); }}
                                                        className="px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors"
                                                    >
                                                        Reopen
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Todo Tab Content */}
                        {activeTab === 'todo' && (
                            <TodoHub boards={boards} currentBoardId={currentBoardId} />
                        )}
                        {/* Suggest Tab Content */}
                        {activeTab === 'suggest' && <SuggestionsView />}
                    </div>

                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                    />
                    <InviteModal
                        isOpen={showInvite}
                        onClose={() => setShowInvite(false)}
                    />

                    {/* Mobile Bottom Navigation */}
                    <nav className="bottom-nav">
                        <button
                            onClick={() => { setActiveTab('dashboard'); setSelectedTopicId(null); }}
                            className={`bottom-nav-item ${activeTab === 'dashboard' ? 'active' : ''}`}
                        >
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                            <span>Home</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('board'); setSelectedTopicId(null); }}
                            className={`bottom-nav-item ${activeTab === 'board' ? 'active' : ''}`}
                        >
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <span>Topics</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('archive'); setSelectedTopicId(null); }}
                            className={`bottom-nav-item ${activeTab === 'archive' ? 'active' : ''}`}
                        >
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                            <span>Archive</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('todo'); setSelectedTopicId(null); }}
                            className={`bottom-nav-item ${activeTab === 'todo' ? 'active' : ''}`}
                        >
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            <span>Todo</span>
                        </button>
                        <button
                            onClick={() => { setActiveTab('suggest'); setSelectedTopicId(null); }}
                            className={`bottom-nav-item ${activeTab === 'suggest' ? 'active' : ''}`}
                        >
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <span>Suggest</span>
                        </button>

                        <button
                            onClick={() => setShowSettings(true)}
                            className={`bottom-nav-item`}
                        >
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span>Settings</span>
                        </button>
                    </nav>

                    {/* Mobile FAB for new topic */}
                    <button
                        onClick={() => setShowTopicForm(true)}
                        className="fab-button"
                        title="New Topic"
                    >
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
            );
        };

        // ============================================
        // APP ROOT
        // ============================================
        const App = () => {
            const { user, loading, boards, authError, retryLoad, signOut } = useContext(AuthContext);

            if (loading) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center">
                        <Spinner />
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen />;
            }

            // Show Critical Data Load Errors
            if (authError) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center p-4">
                        <div className="bg-red-50 p-6 rounded-lg max-w-md w-full text-center border border-red-100">
                            <h2 className="text-xl font-bold text-red-800 mb-2">Something went wrong</h2>
                            <p className="text-red-600 mb-6">{authError}</p>
                            <div className="flex gap-3 justify-center">
                                <button
                                    onClick={() => window.location.reload()}
                                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                >
                                    Reload Page
                                </button>
                                <button
                                    onClick={signOut}
                                    className="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50"
                                >
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (boards.length === 0) {
                return <OnboardingScreen />;
            }

            return (
                <TodoProvider boards={boards}>
                    <BoardProvider>
                        <Dashboard />
                    </BoardProvider>
                </TodoProvider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <AuthProvider>
                <App />
            </AuthProvider>
        );
    </script>
</body>

</html>