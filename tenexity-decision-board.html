<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenexity Decision Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes pulse-recording {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .recording-pulse {
            animation: pulse-recording 1.5s ease-in-out infinite;
        }

        .audio-waveform {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // ============================================
        // TENEXITY LOGO COMPONENT
        // ============================================
        const TenexityLogo = ({ size = 40, className = "" }) => (
            <img
                src="logo.jpg"
                alt="Tenexity Logo"
                style={{ width: size, height: size, objectFit: 'contain' }}
                className={className}
            />
        );

        const TenexityLogoFull = ({ height = 32 }) => (
            <div className="flex items-center gap-1">
                <span className="text-xl font-light tracking-widest text-gray-900">Tene</span>
                <TenexityLogo size={height} />
                <span className="text-xl font-light tracking-widest text-gray-900">ity</span>
            </div>
        );

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // IMPORTANT: Replace these with your Supabase project credentials
        // Get these from: Supabase Dashboard > Project Settings > API
        const SUPABASE_URL = 'https://nilgqhewhxyvgufevsuw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbGdxaGV3aHh5dmd1ZmV2c3V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNjk2MjQsImV4cCI6MjA4Mzg0NTYyNH0.glEw2hN7lVjlUyl3GdIP1D58oxl83moCKXnJn8zlKQo';

        // Initialize Supabase (only if config is set)
        let supabaseClient = null;
        const isSupabaseConfigured = SUPABASE_URL !== 'YOUR_SUPABASE_URL';

        // Debug: Check if Supabase SDK loaded
        console.log('Supabase SDK loaded:', !!window.supabase);
        console.log('Supabase configured:', isSupabaseConfigured);

        if (isSupabaseConfigured && window.supabase) {
            try {
                // The UMD build exposes createClient directly on window.supabase
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client created successfully');
            } catch (err) {
                console.error('Error creating Supabase client:', err);
            }
        } else if (isSupabaseConfigured && !window.supabase) {
            console.error('Supabase SDK not loaded! window.supabase is undefined');
        }

        // ============================================
        // CONTEXTS
        // ============================================
        const AuthContext = createContext(null);
        const BoardContext = createContext(null);

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const generateInviteCode = () => Math.random().toString(36).substr(2, 8).toUpperCase();

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const formatDuration = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        // ============================================
        // AUTH PROVIDER (SUPABASE)
        // ============================================
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [boards, setBoards] = useState([]);
            const [currentBoardId, setCurrentBoardId] = useState(null);
            const [isDevMode, setIsDevMode] = useState(false);

            useEffect(() => {
                if (!isSupabaseConfigured || !supabaseClient) {
                    setLoading(false);
                    return;
                }

                // Get initial session
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session?.user) {
                        setUser(session.user);
                        loadUserData(session.user);
                    } else {
                        setLoading(false);
                    }
                });

                // Listen for auth changes
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    if (session?.user) {
                        setUser(session.user);
                        await loadUserData(session.user);
                    } else {
                        setUser(null);
                        setUserProfile(null);
                        setBoards([]);
                        setCurrentBoardId(null);
                    }
                    setLoading(false);
                });

                return () => subscription.unsubscribe();
            }, []);

            const loadUserData = async (user) => {
                try {
                    // Get or create user profile
                    let { data: profile, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();

                    if (error && error.code === 'PGRST116') {
                        // Profile doesn't exist, create it
                        const newProfile = {
                            id: user.id,
                            email: user.email,
                            display_name: user.email.split('@')[0],
                            created_at: new Date().toISOString()
                        };
                        const { data, error: insertError } = await supabaseClient
                            .from('profiles')
                            .insert(newProfile)
                            .select()
                            .single();

                        if (!insertError) {
                            profile = data;
                        }
                    }

                    if (profile) {
                        setUserProfile({
                            displayName: profile.display_name,
                            email: profile.email
                        });
                    }

                    // Get user's boards
                    const { data: memberData } = await supabaseClient
                        .from('board_members')
                        .select('board_id')
                        .eq('user_id', user.id);

                    if (memberData && memberData.length > 0) {
                        const boardIds = memberData.map(m => m.board_id);
                        const { data: boardsData } = await supabaseClient
                            .from('boards')
                            .select('*')
                            .in('id', boardIds);

                        if (boardsData) {
                            setBoards(boardsData);
                            if (boardsData.length > 0 && !currentBoardId) {
                                setCurrentBoardId(boardsData[0].id);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error loading user data:', err);
                }
            };

            const sendMagicLink = async (email) => {
                const { error } = await supabaseClient.auth.signInWithOtp({
                    email,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });
                if (error) throw error;
            };

            const devLogin = () => {
                const devUser = { id: 'dev-user-123', email: 'dev@example.com' };
                setIsDevMode(true);
                setUser(devUser);
                setUserProfile({ displayName: 'Developer', email: 'dev@example.com' });
                // Create a dummy board for testing
                const dummyBoard = {
                    id: 'dev-board-123',
                    name: 'Developer Board',
                    owner_id: devUser.id,
                    invite_code: 'DEV123',
                    created_at: new Date().toISOString()
                };

                setBoards([dummyBoard]);
                setCurrentBoardId(dummyBoard.id);
            };

            const signOut = async () => {
                if (!isDevMode) {
                    await supabaseClient.auth.signOut();
                }
                setIsDevMode(false);
                setUser(null);
                setUserProfile(null);
                setBoards([]);
                setCurrentBoardId(null);
            };

            const updateProfile = async (updates) => {
                if (user) {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({ display_name: updates.displayName })
                        .eq('id', user.id);

                    if (!error) {
                        setUserProfile({ ...userProfile, ...updates });
                    }
                }
            };

            const createBoard = async (name) => {
                const inviteCode = generateInviteCode();

                // Create board
                const { data: board, error: boardError } = await supabaseClient
                    .from('boards')
                    .insert({
                        name,
                        owner_id: user.id,
                        invite_code: inviteCode,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (boardError) throw boardError;

                // Add creator as member
                await supabaseClient
                    .from('board_members')
                    .insert({
                        board_id: board.id,
                        user_id: user.id,
                        email: user.email,
                        joined_at: new Date().toISOString()
                    });

                setBoards([...boards, board]);
                setCurrentBoardId(board.id);
                return board;
            };

            const joinBoard = async (inviteCode) => {
                // Find board by invite code
                const { data: board, error: findError } = await supabaseClient
                    .from('boards')
                    .select('*')
                    .eq('invite_code', inviteCode.toUpperCase())
                    .single();

                if (findError || !board) {
                    throw new Error('Invalid invite code');
                }

                // Check if already a member
                const { data: existingMember } = await supabaseClient
                    .from('board_members')
                    .select('*')
                    .eq('board_id', board.id)
                    .eq('user_id', user.id)
                    .single();

                if (existingMember) {
                    throw new Error('You are already a member of this board');
                }

                // Add as member
                await supabaseClient
                    .from('board_members')
                    .insert({
                        board_id: board.id,
                        user_id: user.id,
                        email: user.email,
                        joined_at: new Date().toISOString()
                    });

                setBoards([...boards, board]);
                setCurrentBoardId(board.id);
                return board;
            };

            const inviteByEmail = async (email) => {
                const board = boards.find(b => b.id === currentBoardId);
                if (!board) throw new Error('No board selected');

                return {
                    inviteCode: board.invite_code,
                    inviteLink: `${window.location.origin}${window.location.pathname}?invite=${board.invite_code}`
                };
            };

            return (
                <AuthContext.Provider value={{
                    user,
                    userProfile,
                    loading,
                    boards,
                    currentBoardId,
                    setCurrentBoardId,
                    sendMagicLink,
                    signOut,
                    updateProfile,
                    createBoard,
                    joinBoard,
                    inviteByEmail,
                    joinBoard,
                    joinBoard,
                    inviteByEmail,
                    isSupabaseConfigured,
                    devLogin,
                    isDevMode
                }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // ============================================
        // BOARD DATA PROVIDER (SUPABASE)
        // ============================================
        const BoardProvider = ({ children }) => {
            const { user, currentBoardId, isSupabaseConfigured, isDevMode } = useContext(AuthContext);
            const [topics, setTopics] = useState([]);
            const [boardMembers, setBoardMembers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if ((!isSupabaseConfigured && !isDevMode) || !currentBoardId || !user) {
                    setLoading(false);
                    return;
                }

                // Load topics
                const loadTopics = async () => {
                    if (isDevMode) {
                        const dummySuggestedTopic = {
                            id: 'suggested-123',
                            board_id: currentBoardId,
                            title: 'Email: Potential Partnership with ACME',
                            description: 'Received email from bob@acme.com proposing a joint venture.',
                            status: 'suggested',
                            created_by: 'email-agent',
                            created_at: new Date().toISOString(),
                            contributions: []
                        };
                        // Also include the manually created dev topic if it persists, but for now just this default one
                        setTopics([dummySuggestedTopic]);
                        setLoading(false);
                        return; // Topics are in memory for dev mode
                    }
                    const { data } = await supabaseClient
                        .from('topics')
                        .select('*')
                        .eq('board_id', currentBoardId)
                        .order('created_at', { ascending: false });

                    if (data) {
                        setTopics(data);
                    }
                    setLoading(false);
                };

                loadTopics();

                // Subscribe to real-time updates
                const subscription = supabaseClient
                    .channel(`topics:${currentBoardId}`)
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'topics', filter: `board_id=eq.${currentBoardId}` },
                        (payload) => {
                            if (payload.eventType === 'INSERT') {
                                setTopics(prev => [payload.new, ...prev]);
                            } else if (payload.eventType === 'UPDATE') {
                                setTopics(prev => prev.map(t => t.id === payload.new.id ? payload.new : t));
                            } else if (payload.eventType === 'DELETE') {
                                setTopics(prev => prev.filter(t => t.id !== payload.old.id));
                            }
                        }
                    )
                    .subscribe();

                // Load board members
                const loadMembers = async () => {
                    const { data: memberData } = await supabaseClient
                        .from('board_members')
                        .select('user_id, email')
                        .eq('board_id', currentBoardId);

                    if (memberData) {
                        const memberIds = memberData.map(m => m.user_id);
                        const { data: profiles } = await supabaseClient
                            .from('profiles')
                            .select('*')
                            .in('id', memberIds);

                        if (profiles) {
                            setBoardMembers(profiles.map(p => ({
                                uid: p.id,
                                displayName: p.display_name,
                                email: p.email
                            })));
                        }
                    }
                };

                loadMembers();

                return () => {
                    subscription.unsubscribe();
                };
            }, [currentBoardId, user, isSupabaseConfigured]);

            const addTopic = async (topicData) => {
                if (!supabaseClient || isDevMode) {
                    // Dev mode mock
                    const newTopic = {
                        id: generateId(),
                        board_id: currentBoardId,
                        title: topicData.title,
                        description: topicData.description,
                        due_date: topicData.dueDate,
                        status: topicData.status || 'open',
                        created_by: user.id,
                        contributions: [],
                        created_at: new Date().toISOString()
                    };
                    setTopics([newTopic, ...topics]);
                    return;
                }

                const { error } = await supabaseClient
                    .from('topics')
                    .insert({
                        board_id: currentBoardId,
                        title: topicData.title,
                        description: topicData.description,
                        due_date: topicData.dueDate,
                        status: topicData.status || 'open',
                        created_by: user.id,
                        contributions: [],
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;
            };

            const updateTopic = async (topicId, updates) => {
                if (!supabaseClient || isDevMode) {
                    setTopics(topics.map(t => t.id === topicId ? { ...t, ...updates } : t));
                    return;
                }

                const updateData = {};
                if (updates.status) updateData.status = updates.status;
                if (updates.contributions) updateData.contributions = updates.contributions;

                await supabaseClient
                    .from('topics')
                    .update(updateData)
                    .eq('id', topicId);
            };

            const deleteTopic = async (topicId) => {
                if (!supabaseClient || isDevMode) {
                    setTopics(topics.filter(t => t.id !== topicId));
                    return;
                }

                await supabaseClient
                    .from('topics')
                    .delete()
                    .eq('id', topicId);
            };

            const addContribution = async (topicId, contribution) => {
                const topic = topics.find(t => t.id === topicId);
                const profile = boardMembers.find(m => m.uid === user.id);

                const newContribution = {
                    ...contribution,
                    id: generateId(),
                    userId: user.id,
                    userEmail: user.email,
                    userName: profile?.displayName || user.email.split('@')[0],
                    createdAt: new Date().toISOString(),
                    replies: []
                };

                if (!supabaseClient || isDevMode) {
                    const updatedTopic = {
                        ...topic,
                        contributions: [...(topic.contributions || []), newContribution]
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                    return;
                }

                await supabaseClient
                    .from('topics')
                    .update({
                        contributions: [...(topic.contributions || []), newContribution]
                    })
                    .eq('id', topicId);
            };

            const addReply = async (topicId, parentId, reply) => {
                const topic = topics.find(t => t.id === topicId);
                const profile = boardMembers.find(m => m.uid === user.id);

                const newReply = {
                    ...reply,
                    id: generateId(),
                    userId: user.id,
                    userEmail: user.email,
                    userName: profile?.displayName || user.email.split('@')[0],
                    createdAt: new Date().toISOString(),
                    replies: []
                };

                const addReplyToContribution = (contributions) => {
                    return contributions.map(c => {
                        if (c.id === parentId) {
                            return { ...c, replies: [...(c.replies || []), newReply] };
                        }
                        if (c.replies) {
                            return { ...c, replies: addReplyToContribution(c.replies) };
                        }
                        return c;
                    });
                };

                if (!supabaseClient || isDevMode) {
                    const updatedTopic = {
                        ...topic,
                        contributions: addReplyToContribution(topic.contributions || [])
                    };
                    setTopics(topics.map(t => t.id === topicId ? updatedTopic : t));
                    return;
                }

                await supabaseClient
                    .from('topics')
                    .update({
                        contributions: addReplyToContribution(topic.contributions || [])
                    })
                    .eq('id', topicId);
            };

            return (
                <BoardContext.Provider value={{
                    topics,
                    boardMembers,
                    loading,
                    addTopic,
                    updateTopic,
                    deleteTopic,
                    addContribution,
                    addReply
                }}>
                    {children}
                </BoardContext.Provider>
            );
        };

        // ============================================
        // UI COMPONENTS
        // ============================================

        // Loading spinner
        const Spinner = () => (
            <div className="flex items-center justify-center p-8">
                <div className="w-8 h-8 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
            </div>
        );

        // Category badge component
        const CategoryBadge = ({ category }) => {
            const colors = {
                opinion: 'bg-purple-100 text-purple-800 border-purple-200',
                fact: 'bg-blue-100 text-blue-800 border-blue-200',
                preference: 'bg-green-100 text-green-800 border-green-200'
            };
            return (
                <span className={`px-2 py-1 text-xs font-medium rounded-full border ${colors[category]}`}>
                    {category.charAt(0).toUpperCase() + category.slice(1)}
                </span>
            );
        };

        // User badge component
        const UserBadge = ({ userName, isCurrentUser }) => {
            return (
                <span className={`px-2 py-1 text-xs font-medium text-white rounded-full ${isCurrentUser ? 'bg-gray-900' : 'bg-gray-500'
                    }`}>
                    {userName} {isCurrentUser && '(you)'}
                </span>
            );
        };

        // Status badge component
        const StatusBadge = ({ status }) => {
            const colors = {
                open: 'bg-yellow-100 text-yellow-800',
                pending: 'bg-orange-100 text-orange-800',
                decided: 'bg-green-100 text-green-800'
            };
            return (
                <span className={`px-2 py-1 text-xs font-medium rounded ${colors[status]}`}>
                    {status.charAt(0).toUpperCase() + status.slice(1)}
                </span>
            );
        };

        // Voice recorder component
        const VoiceRecorder = ({ onRecordingComplete }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [duration, setDuration] = useState(0);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];

                    mediaRecorderRef.current.ondataavailable = (e) => {
                        chunksRef.current.push(e.data);
                    };

                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            onRecordingComplete({
                                data: reader.result,
                                duration: duration
                            });
                        };
                        reader.readAsDataURL(blob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setDuration(0);
                    timerRef.current = setInterval(() => {
                        setDuration(d => d + 1);
                    }, 1000);
                } catch (err) {
                    alert('Could not access microphone. Please ensure microphone permissions are granted.');
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    clearInterval(timerRef.current);
                }
            };

            return (
                <div className="flex items-center gap-3">
                    {!isRecording ? (
                        <button
                            onClick={startRecording}
                            className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                        >
                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="10" cy="10" r="6" />
                            </svg>
                            Record Voice Note
                        </button>
                    ) : (
                        <div className="flex items-center gap-3">
                            <div className="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg">
                                <span className="w-3 h-3 bg-red-500 rounded-full recording-pulse"></span>
                                Recording... {formatDuration(duration)}
                            </div>
                            <button
                                onClick={stopRecording}
                                className="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors"
                            >
                                Stop
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // Audio player component
        const AudioPlayer = ({ audioData, duration }) => {
            const audioRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);

            useEffect(() => {
                const audio = audioRef.current;
                if (audio) {
                    audio.ontimeupdate = () => setCurrentTime(audio.currentTime);
                    audio.onended = () => setIsPlaying(false);
                }
            }, []);

            const togglePlay = () => {
                if (audioRef.current) {
                    if (isPlaying) {
                        audioRef.current.pause();
                    } else {
                        audioRef.current.play();
                    }
                    setIsPlaying(!isPlaying);
                }
            };

            return (
                <div className="flex items-center gap-3 p-3 bg-gray-100 rounded-lg">
                    <audio ref={audioRef} src={audioData} />
                    <button
                        onClick={togglePlay}
                        className="w-10 h-10 flex items-center justify-center bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-colors"
                    >
                        {isPlaying ? (
                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <rect x="5" y="4" width="3" height="12" />
                                <rect x="12" y="4" width="3" height="12" />
                            </svg>
                        ) : (
                            <svg className="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                <polygon points="5,3 19,10 5,17" />
                            </svg>
                        )}
                    </button>
                    <div className="flex-1">
                        <div className="h-2 bg-gray-300 rounded-full overflow-hidden">
                            <div
                                className="h-full bg-gray-900 transition-all duration-100"
                                style={{ width: `${(currentTime / (duration || 1)) * 100}%` }}
                            />
                        </div>
                    </div>
                    <span className="text-sm text-gray-600 font-mono">
                        {formatDuration(currentTime)} / {formatDuration(duration)}
                    </span>
                </div>
            );
        };

        // Contribution component
        const Contribution = ({ contribution, topicId, level = 0 }) => {
            const { user } = useContext(AuthContext);
            const { addReply } = useContext(BoardContext);
            const [showReplyForm, setShowReplyForm] = useState(false);

            const isCurrentUser = contribution.userId === user?.id;

            const handleReply = async (replyData) => {
                await addReply(topicId, contribution.id, replyData);
                setShowReplyForm(false);
            };

            return (
                <div className={`${level > 0 ? 'ml-8 border-l-2 border-gray-200 pl-4' : ''}`}>
                    <div className="bg-white rounded-lg border border-gray-200 p-4 mb-3 shadow-sm">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <UserBadge userName={contribution.userName} isCurrentUser={isCurrentUser} />
                                <CategoryBadge category={contribution.category} />
                                <span className="text-sm text-gray-500">
                                    {formatDate(contribution.createdAt)}
                                </span>
                            </div>
                            {contribution.isApproval && (
                                <span className="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full">
                                    ‚úì Approved
                                </span>
                            )}
                        </div>

                        {contribution.text && (
                            <p className="text-gray-700 mb-3">{contribution.text}</p>
                        )}

                        {contribution.voiceNote && (
                            <div className="mb-3">
                                <AudioPlayer
                                    audioData={contribution.voiceNote.data}
                                    duration={contribution.voiceNote.duration}
                                />
                            </div>
                        )}

                        {contribution.links && contribution.links.length > 0 && (
                            <div className="mb-3">
                                <h4 className="text-sm font-medium text-gray-600 mb-2">Attached Links:</h4>
                                <div className="space-y-1">
                                    {contribution.links.map((link, idx) => (
                                        <a
                                            key={idx}
                                            href={link.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="flex items-center gap-2 text-blue-600 hover:text-blue-800 text-sm"
                                        >
                                            {link.url.includes('docs.google.com') && <span className="text-blue-500">üìÑ</span>}
                                            {link.url.includes('drive.google.com') && <span className="text-green-500">üìÅ</span>}
                                            {link.url.includes('sheets.google.com') && <span className="text-green-600">üìä</span>}
                                            {!link.url.includes('google.com') && <span>üîó</span>}
                                            {link.title || link.url}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}

                        <button
                            onClick={() => setShowReplyForm(!showReplyForm)}
                            className="text-sm text-gray-600 hover:text-gray-900 font-medium"
                        >
                            {showReplyForm ? 'Cancel Reply' : 'Reply'}
                        </button>

                        {showReplyForm && (
                            <div className="mt-3 pt-3 border-t border-gray-200">
                                <ContributionForm onSubmit={handleReply} isReply={true} />
                            </div>
                        )}
                    </div>

                    {contribution.replies && contribution.replies.map(reply => (
                        <Contribution
                            key={reply.id}
                            contribution={reply}
                            topicId={topicId}
                            level={level + 1}
                        />
                    ))}
                </div>
            );
        };

        // Contribution form component
        const ContributionForm = ({ onSubmit, isReply = false }) => {
            const [text, setText] = useState('');
            const [category, setCategory] = useState('opinion');
            const [voiceNote, setVoiceNote] = useState(null);
            const [links, setLinks] = useState([]);
            const [linkInput, setLinkInput] = useState('');
            const [isApproval, setIsApproval] = useState(false);
            const [submitting, setSubmitting] = useState(false);

            const addLink = () => {
                if (linkInput.trim()) {
                    setLinks([...links, { url: linkInput.trim(), title: '' }]);
                    setLinkInput('');
                }
            };

            const removeLink = (idx) => {
                setLinks(links.filter((_, i) => i !== idx));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!text.trim() && !voiceNote && links.length === 0) {
                    alert('Please add some content (text, voice note, or links)');
                    return;
                }
                setSubmitting(true);
                try {
                    await onSubmit({
                        category,
                        text: text.trim(),
                        voiceNote,
                        links,
                        isApproval
                    });
                    setText('');
                    setCategory('opinion');
                    setVoiceNote(null);
                    setLinks([]);
                    setIsApproval(false);
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="flex gap-4 flex-wrap">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            >
                                <option value="opinion">Opinion</option>
                                <option value="fact">Fact</option>
                                <option value="preference">Preference</option>
                            </select>
                        </div>
                        {isReply && (
                            <div className="flex items-end">
                                <label className="flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-lg cursor-pointer hover:bg-green-100">
                                    <input
                                        type="checkbox"
                                        checked={isApproval}
                                        onChange={(e) => setIsApproval(e.target.checked)}
                                        className="w-4 h-4 text-green-600"
                                    />
                                    <span className="text-green-700 font-medium">Mark as Approval</span>
                                </label>
                            </div>
                        )}
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Your Input</label>
                        <textarea
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            placeholder="Share your thoughts, facts, or preferences..."
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent resize-none"
                            rows={3}
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Voice Note</label>
                        {voiceNote ? (
                            <div className="space-y-2">
                                <AudioPlayer audioData={voiceNote.data} duration={voiceNote.duration} />
                                <button
                                    type="button"
                                    onClick={() => setVoiceNote(null)}
                                    className="text-sm text-red-600 hover:text-red-800"
                                >
                                    Remove recording
                                </button>
                            </div>
                        ) : (
                            <VoiceRecorder onRecordingComplete={setVoiceNote} />
                        )}
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Document Links</label>
                        <div className="flex gap-2 mb-2">
                            <input
                                type="url"
                                value={linkInput}
                                onChange={(e) => setLinkInput(e.target.value)}
                                placeholder="Paste Google Drive, Docs, or any URL..."
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            />
                            <button
                                type="button"
                                onClick={addLink}
                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                            >
                                Add Link
                            </button>
                        </div>
                        {links.length > 0 && (
                            <div className="space-y-1">
                                {links.map((link, idx) => (
                                    <div key={idx} className="flex items-center gap-2 text-sm">
                                        <span className="text-blue-600 truncate flex-1">{link.url}</span>
                                        <button
                                            type="button"
                                            onClick={() => removeLink(idx)}
                                            className="text-red-500 hover:text-red-700"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <button
                        type="submit"
                        disabled={submitting}
                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                    >
                        {submitting ? 'Posting...' : isReply ? 'Post Reply' : 'Add Contribution'}
                    </button>
                </form>
            );
        };

        // Topic form component
        const TopicForm = ({ onSubmit, onCancel }) => {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!title.trim()) return;
                setSubmitting(true);
                try {
                    await onSubmit({
                        title: title.trim(),
                        description: description.trim(),
                        dueDate: dueDate || null,
                        status: 'open'
                    });
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4 p-4 bg-white rounded-lg border border-gray-200">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Topic Title *</label>
                        <input
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="e.g., Q1 Marketing Budget Allocation"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="Provide context about this decision..."
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent resize-none"
                            rows={2}
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input
                            type="date"
                            value={dueDate}
                            onChange={(e) => setDueDate(e.target.value)}
                            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                        />
                    </div>
                    <div className="flex gap-2">
                        <button
                            type="submit"
                            disabled={submitting}
                            className="flex-1 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                        >
                            {submitting ? 'Creating...' : 'Create Topic'}
                        </button>
                        <button
                            type="button"
                            onClick={onCancel}
                            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            );
        };

        // AI Summary component
        const AISummary = ({ topic, apiKey }) => {
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const generateSummary = async () => {
                if (!apiKey) {
                    setError('Please add your Claude API key in Settings');
                    return;
                }

                setLoading(true);
                setError(null);

                const gatherText = (contributions, prefix = '') => {
                    let text = '';
                    contributions.forEach(c => {
                        text += `${prefix}[${c.userName}] (${c.category}): ${c.text || '(voice note)'}\n`;
                        if (c.links?.length) {
                            text += `${prefix}  Links: ${c.links.map(l => l.url).join(', ')}\n`;
                        }
                        if (c.isApproval) {
                            text += `${prefix}  ** APPROVED **\n`;
                        }
                        if (c.replies?.length) {
                            text += gatherText(c.replies, prefix + '  ‚Üí ');
                        }
                    });
                    return text;
                };

                const contributionText = gatherText(topic.contributions || []);

                const prompt = `You are helping cofounders make decisions asynchronously.

Topic: ${topic.title}
Description: ${topic.description || 'No description'}
Status: ${topic.status}

Contributions:
${contributionText || 'No contributions yet'}

Please provide:
1. A brief summary of the discussion so far
2. Each person's stated preferences or positions
3. Key facts mentioned
4. Any agreements or approvals given
5. What still needs to be decided or discussed

Keep it concise and actionable.`;

                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1024,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    if (!response.ok) throw new Error('API request failed');

                    const data = await response.json();
                    setSummary(data.content[0].text);
                } catch (err) {
                    setError('Failed to generate summary. Please check your API key.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-gray-50 rounded-lg border border-gray-200 p-4">
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                            <span>‚ú®</span> AI Summary
                        </h3>
                        <button
                            onClick={generateSummary}
                            disabled={loading}
                            className="px-4 py-1.5 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Generating...' : summary ? 'Refresh' : 'Generate Summary'}
                        </button>
                    </div>

                    {error && <p className="text-red-600 text-sm">{error}</p>}

                    {summary && (
                        <div className="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap">
                            {summary}
                        </div>
                    )}

                    {!summary && !error && !loading && (
                        <p className="text-gray-500 text-sm">
                            Click "Generate Summary" to get an AI-powered overview of this topic's discussion.
                        </p>
                    )}
                </div>
            );
        };

        // ============================================
        // LOGIN SCREEN
        // ============================================
        const LoginScreen = () => {
            const { sendMagicLink, isSupabaseConfigured, devLogin } = useContext(AuthContext);
            const [email, setEmail] = useState('');
            const [sent, setSent] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await sendMagicLink(email);
                    setSent(true);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!isSupabaseConfigured) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="flex justify-center mb-4">
                                    <TenexityLogo size={64} />
                                </div>
                                <TenexityLogoFull height={28} />
                                <p className="text-gray-500 mt-4">Decision Board</p>
                                <p className="text-amber-600 mt-2 text-sm font-medium">Supabase Setup Required</p>
                            </div>

                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                                <h3 className="font-semibold text-amber-800 mb-2">‚ö†Ô∏è Configuration Needed</h3>
                                <p className="text-amber-700 text-sm mb-3">
                                    To enable user authentication and real-time sync, you need to set up Supabase:
                                </p>
                                <ol className="text-amber-700 text-sm space-y-2 list-decimal list-inside">
                                    <li>Go to <a href="https://supabase.com" target="_blank" className="underline">supabase.com</a></li>
                                    <li>Create a new project</li>
                                    <li>Run the database schema (see setup guide)</li>
                                    <li>Copy your URL and anon key to this file</li>
                                </ol>
                            </div>

                            <p className="text-gray-500 text-sm text-center">
                                See the setup instructions file for detailed steps.
                            </p>

                            <div className="mt-6 pt-6 border-t border-gray-100">
                                <button
                                    onClick={devLogin}
                                    className="w-full py-2 bg-gray-100 text-gray-600 font-medium rounded-lg hover:bg-gray-200 transition-colors text-sm"
                                >
                                    üîß Bypass Login (Developer Mode)
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (sent) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md text-center">
                            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span className="text-green-600 text-3xl">‚úâÔ∏è</span>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Check Your Email</h2>
                            <p className="text-gray-600 mb-4">
                                We sent a magic link to <strong>{email}</strong>
                            </p>
                            <p className="text-gray-500 text-sm">
                                Click the link in the email to sign in. You can close this tab.
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-4">
                                <TenexityLogo size={64} />
                            </div>
                            <TenexityLogoFull height={28} />
                            <p className="text-gray-500 mt-4">Sign in to collaborate</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="you@example.com"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                    required
                                />
                            </div>

                            {error && (
                                <p className="text-red-600 text-sm">{error}</p>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                            >
                                {loading ? 'Sending...' : 'Send Magic Link'}
                            </button>
                        </form>

                        <p className="text-gray-500 text-sm text-center mt-6">
                            No password needed! We'll email you a secure login link.
                        </p>

                        <div className="mt-8 pt-6 border-t border-gray-100">
                            <button
                                onClick={devLogin}
                                className="w-full py-2 bg-gray-50 text-gray-500 font-medium rounded-lg hover:bg-gray-100 transition-colors text-sm"
                            >
                                üîß Developer Login
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // ONBOARDING SCREEN
        // ============================================
        const OnboardingScreen = () => {
            const { createBoard, joinBoard, userProfile, updateProfile } = useContext(AuthContext);
            const [step, setStep] = useState('name');
            const [displayName, setDisplayName] = useState(userProfile?.displayName || '');
            const [boardName, setBoardName] = useState('');
            const [inviteCode, setInviteCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const invite = params.get('invite');
                if (invite) {
                    setInviteCode(invite);
                    setStep('join');
                }
            }, []);

            const handleNameSubmit = async (e) => {
                e.preventDefault();
                if (!displayName.trim()) return;
                setLoading(true);
                try {
                    await updateProfile({ displayName: displayName.trim() });
                    setStep('choice');
                } finally {
                    setLoading(false);
                }
            };

            const handleCreateBoard = async (e) => {
                e.preventDefault();
                if (!boardName.trim()) return;
                setLoading(true);
                setError('');
                try {
                    await createBoard(boardName.trim());
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleJoinBoard = async (e) => {
                e.preventDefault();
                if (!inviteCode.trim()) return;
                setLoading(true);
                setError('');
                try {
                    await joinBoard(inviteCode.trim());
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 w-full max-w-md">
                        {step === 'name' && (
                            <>
                                <div className="text-center mb-8">
                                    <TenexityLogo size={48} className="mx-auto mb-4" />
                                    <h2 className="text-2xl font-bold text-gray-900">Welcome! üëã</h2>
                                    <p className="text-gray-500 mt-2">What should we call you?</p>
                                </div>
                                <form onSubmit={handleNameSubmit} className="space-y-4">
                                    <input
                                        type="text"
                                        value={displayName}
                                        onChange={(e) => setDisplayName(e.target.value)}
                                        placeholder="Your name"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent text-center text-lg"
                                        required
                                    />
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                    >
                                        Continue
                                    </button>
                                </form>
                            </>
                        )}

                        {step === 'choice' && (
                            <>
                                <div className="text-center mb-8">
                                    <TenexityLogo size={48} className="mx-auto mb-4" />
                                    <h2 className="text-2xl font-bold text-gray-900">Hi, {displayName}!</h2>
                                    <p className="text-gray-500 mt-2">How would you like to get started?</p>
                                </div>
                                <div className="space-y-4">
                                    <button
                                        onClick={() => setStep('create')}
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-gray-900 hover:bg-gray-50 transition-colors text-left"
                                    >
                                        <div className="font-semibold text-gray-900">Create a New Board</div>
                                        <div className="text-sm text-gray-500">Start fresh and invite your cofounder</div>
                                    </button>
                                    <button
                                        onClick={() => setStep('join')}
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-gray-400 hover:bg-gray-50 transition-colors text-left"
                                    >
                                        <div className="font-semibold text-gray-900">Join an Existing Board</div>
                                        <div className="text-sm text-gray-500">I have an invite code</div>
                                    </button>
                                </div>
                            </>
                        )}

                        {step === 'create' && (
                            <>
                                <button onClick={() => setStep('choice')} className="text-gray-500 hover:text-gray-700 mb-4">
                                    ‚Üê Back
                                </button>
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-900">Create Your Board</h2>
                                    <p className="text-gray-500 mt-2">Give your decision board a name</p>
                                </div>
                                <form onSubmit={handleCreateBoard} className="space-y-4">
                                    <input
                                        type="text"
                                        value={boardName}
                                        onChange={(e) => setBoardName(e.target.value)}
                                        placeholder="e.g., Graham & Nick Decisions"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                        required
                                    />
                                    {error && <p className="text-red-600 text-sm">{error}</p>}
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                    >
                                        {loading ? 'Creating...' : 'Create Board'}
                                    </button>
                                </form>
                            </>
                        )}

                        {step === 'join' && (
                            <>
                                <button onClick={() => setStep('choice')} className="text-gray-500 hover:text-gray-700 mb-4">
                                    ‚Üê Back
                                </button>
                                <div className="text-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-900">Join a Board</h2>
                                    <p className="text-gray-500 mt-2">Enter the invite code from your cofounder</p>
                                </div>
                                <form onSubmit={handleJoinBoard} className="space-y-4">
                                    <input
                                        type="text"
                                        value={inviteCode}
                                        onChange={(e) => setInviteCode(e.target.value.toUpperCase())}
                                        placeholder="XXXXXXXX"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent text-center text-2xl tracking-widest font-mono"
                                        maxLength={8}
                                        required
                                    />
                                    {error && <p className="text-red-600 text-sm">{error}</p>}
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="w-full py-3 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                                    >
                                        {loading ? 'Joining...' : 'Join Board'}
                                    </button>
                                </form>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // ============================================
        // INVITE MODAL
        // ============================================
        const InviteModal = ({ isOpen, onClose }) => {
            const { boards, currentBoardId, inviteByEmail } = useContext(AuthContext);
            const [email, setEmail] = useState('');
            const [inviteInfo, setInviteInfo] = useState(null);
            const [copied, setCopied] = useState(false);

            const currentBoard = boards.find(b => b.id === currentBoardId);

            useEffect(() => {
                if (isOpen && currentBoard) {
                    setInviteInfo({
                        inviteCode: currentBoard.invite_code,
                        inviteLink: `${window.location.origin}${window.location.pathname}?invite=${currentBoard.invite_code}`
                    });
                }
            }, [isOpen, currentBoard]);

            const copyLink = () => {
                navigator.clipboard.writeText(inviteInfo?.inviteLink);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const sendEmail = async () => {
                alert(`Share this link with ${email}:\n${inviteInfo?.inviteLink}`);
                setEmail('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-xl font-bold">Invite Your Cofounder</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Share Invite Link
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={inviteInfo?.inviteLink || ''}
                                        readOnly
                                        className="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm"
                                    />
                                    <button
                                        onClick={copyLink}
                                        className="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800"
                                    >
                                        {copied ? '‚úì Copied' : 'Copy'}
                                    </button>
                                </div>
                            </div>

                            <div className="bg-gray-50 rounded-lg p-4 text-center">
                                <p className="text-sm text-gray-600 mb-2">Or share this invite code:</p>
                                <div className="text-3xl font-mono font-bold text-gray-900 tracking-widest">
                                    {inviteInfo?.inviteCode}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Send via Email
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="cofounder@example.com"
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                                    />
                                    <button
                                        onClick={sendEmail}
                                        disabled={!email}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                                    >
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // SETTINGS MODAL
        // ============================================
        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey }) => {
            const { userProfile, updateProfile, signOut } = useContext(AuthContext);
            const [inputKey, setInputKey] = useState(apiKey);
            const [displayName, setDisplayName] = useState(userProfile?.displayName || '');
            const [emailNotifications, setEmailNotifications] = useState(userProfile?.email_notifications || false);
            const [saving, setSaving] = useState(false);

            if (!isOpen) return null;

            const handleSave = async () => {
                setSaving(true);
                try {
                    setApiKey(inputKey);
                    localStorage.setItem('claudeApiKey', inputKey);
                    if (displayName !== userProfile?.displayName || emailNotifications !== userProfile?.email_notifications) {
                        await updateProfile({
                            displayName,
                            email_notifications: emailNotifications
                        });
                    }
                    onClose();
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md">
                        <h2 className="text-xl font-bold mb-6">Settings</h2>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Display Name
                                </label>
                                <input
                                    type="text"
                                    value={displayName}
                                    onChange={(e) => setDisplayName(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Claude API Key
                                </label>
                                <input
                                    type="password"
                                    value={inputKey}
                                    onChange={(e) => setInputKey(e.target.value)}
                                    placeholder="sk-ant-..."
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                    Required for AI summaries. Get your key at console.anthropic.com
                                </p>
                            </div>

                            <div className="flex items-center justify-between">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Daily Summary Emails</label>
                                    <p className="text-xs text-gray-500">Receive a daily digest of active topics</p>
                                </div>
                                <button
                                    onClick={() => setEmailNotifications(!emailNotifications)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${emailNotifications ? 'bg-green-600' : 'bg-gray-200'}`}
                                >
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${emailNotifications ? 'translate-x-6' : 'translate-x-1'}`} />
                                </button>
                            </div>

                            <div className="pt-4 border-t">
                                <button
                                    onClick={signOut}
                                    className="w-full py-2 text-red-600 font-medium hover:bg-red-50 rounded-lg"
                                >
                                    Sign Out
                                </button>
                            </div>
                        </div>

                        <div className="flex gap-2 mt-6">
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                className="flex-1 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-gray-800 disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save'}
                            </button>
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // KANBAN BOARD
        // ============================================
        const KanbanBoard = ({ topics, onTopicClick, onUpdateStatus }) => {
            const columns = [
                { id: 'suggested', title: 'Inbox', color: 'bg-orange-50 border-orange-200', textColor: 'text-orange-800' },
                { id: 'open', title: 'Discussion', color: 'bg-blue-50 border-blue-200', textColor: 'text-blue-800' },
                { id: 'pending', title: 'Pending', color: 'bg-purple-50 border-purple-200', textColor: 'text-purple-800' },
                { id: 'decided', title: 'Decided', color: 'bg-green-50 border-green-200', textColor: 'text-green-800' }
            ];

            return (
                <div className="flex gap-4 h-[calc(100vh-200px)] overflow-x-auto pb-4">
                    {columns.map(col => {
                        const colTopics = topics.filter(t => t.status === col.id);
                        return (
                            <div key={col.id} className="w-80 flex-shrink-0 flex flex-col bg-gray-50 rounded-xl border border-gray-200">
                                <div className={`p-3 border-b border-gray-200 rounded-t-xl font-semibold flex justify-between items-center ${col.color} ${col.textColor}`}>
                                    <span>{col.title}</span>
                                    <span className="text-xs opacity-70 bg-white px-2 py-0.5 rounded-full">
                                        {colTopics.length}
                                    </span>
                                </div>
                                <div className="p-3 flex-1 overflow-y-auto space-y-3">
                                    {colTopics.map(topic => (
                                        <div
                                            key={topic.id}
                                            onClick={() => onTopicClick(topic.id)}
                                            className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:shadow-md transition-shadow group relative"
                                        >
                                            <h4 className="font-medium text-gray-900 text-sm mb-1">{topic.title}</h4>
                                            <div className="flex items-center justify-between text-xs text-gray-500">
                                                <span>{formatDate(topic.created_at)}</span>
                                                {topic.due_date && (
                                                    <span className="text-orange-600 font-medium">
                                                        Due: {new Date(topic.due_date).toLocaleDateString()}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Quick Actions (Hover) */}
                                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white rounded shadow-sm">
                                                {col.id !== 'decided' && (
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); onUpdateStatus(topic.id, 'decided'); }}
                                                        className="p-1 hover:bg-green-50 text-green-600 rounded" title="Move to Decided"
                                                    >
                                                        ‚úì
                                                    </button>
                                                )}
                                                {col.id === 'suggested' && (
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); onUpdateStatus(topic.id, 'open'); }}
                                                        className="p-1 hover:bg-blue-50 text-blue-600 rounded" title="Approve / Move to Open"
                                                    >
                                                        ‚Üí
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // ============================================
        // MAIN DASHBOARD
        // ============================================
        const Dashboard = () => {
            const { user, userProfile, boards, currentBoardId } = useContext(AuthContext);
            const { topics, boardMembers, loading, addTopic, updateTopic, deleteTopic, addContribution } = useContext(BoardContext);

            const [selectedTopicId, setSelectedTopicId] = useState(null);
            const [showTopicForm, setShowTopicForm] = useState(false);
            const [sortBy, setSortBy] = useState('date');
            const [showSettings, setShowSettings] = useState(false);
            const [showInvite, setShowInvite] = useState(false);
            const [viewMode, setViewMode] = useState('list'); // 'list' or 'kanban'
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('claudeApiKey') || '');

            const currentBoard = boards.find(b => b.id === currentBoardId);
            const selectedTopic = topics.find(t => t.id === selectedTopicId);

            const sortedTopics = [...topics].sort((a, b) => {
                if (sortBy === 'date') {
                    return new Date(b.created_at) - new Date(a.created_at);
                } else {
                    return a.title.localeCompare(b.title);
                }
            });

            const suggestedTopics = sortedTopics.filter(t => t.status === 'suggested');
            const activeTopics = sortedTopics.filter(t => t.status !== 'suggested');

            const handleApproveTopic = async (topicId) => {
                await updateTopic(topicId, { status: 'open' });
            };

            const handleAddTopic = async (topicData) => {
                await addTopic(topicData);
                setShowTopicForm(false);
            };

            const handleUpdateStatus = async (status, topicId = null) => {
                const idToUpdate = topicId || selectedTopicId;
                await updateTopic(idToUpdate, { status });
            };

            const handleDeleteTopic = async () => {
                if (confirm('Are you sure you want to delete this topic?')) {
                    await deleteTopic(selectedTopicId);
                    setSelectedTopicId(null);
                }
            };

            const handleAddContribution = async (contribution) => {
                await addContribution(selectedTopicId, contribution);
            };

            if (loading) {
                return <Spinner />;
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <TenexityLogo size={36} />
                                    <div>
                                        <h1 className="text-xl font-bold text-gray-900">
                                            {currentBoard?.name || 'Decision Board'}
                                        </h1>
                                        <p className="text-sm text-gray-500">
                                            {boardMembers.length} member{boardMembers.length !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {/* View Switcher */}
                                    <div className="flex bg-gray-100 rounded-lg p-1 mr-2">
                                        <button
                                            onClick={() => setViewMode('list')}
                                            className={`p-1.5 rounded-md transition-all ${viewMode === 'list' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400 hover:text-gray-600'}`}
                                            title="List View"
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                                        </button>
                                        <button
                                            onClick={() => setViewMode('kanban')}
                                            className={`p-1.5 rounded-md transition-all ${viewMode === 'kanban' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400 hover:text-gray-600'}`}
                                            title="Kanban View"
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>
                                        </button>
                                    </div>

                                    <button
                                        onClick={() => setShowTopicForm(true)}
                                        className="px-3 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors"
                                    >
                                        + New Topic
                                    </button>
                                    <button
                                        onClick={() => setShowInvite(true)}
                                        className="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors"
                                    >
                                        + Invite Cofounder
                                    </button>
                                    <div className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg">
                                        <div className="w-8 h-8 bg-gray-900 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                            {userProfile?.displayName?.charAt(0).toUpperCase()}
                                        </div>
                                        <span className="text-sm font-medium text-gray-700">
                                            {userProfile?.displayName}
                                        </span>
                                    </div>
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header >

                    {/* Main content */}
                    < div className="max-w-7xl mx-auto px-4 py-6" >
                        <div className="flex gap-6">
                            {/* Main View Area */}
                            {viewMode === 'kanban' ? (
                                <div className="flex-1 min-w-0 overflow-x-hidden">
                                    <KanbanBoard
                                        topics={topics}
                                        onTopicClick={setSelectedTopicId}
                                        onUpdateStatus={(id, status) => handleUpdateStatus(status, id)} // Wrap to pass ID if needed
                                    />
                                </div>
                            ) : (
                                <div className="flex gap-6">
                                    {/* Left panel - Topic list */}
                                    <div className="w-80 flex-shrink-0">
                                        <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                            <div className="p-4 border-b border-gray-200">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h2 className="font-semibold text-gray-800">Topics</h2>
                                                    <div className="flex gap-2">
                                                        {/* View Switcher moved to Header */}
                                                    </div>
                                                </div>

                                                {/* Suggested Topics Section */}
                                                {suggestedTopics.length > 0 && (
                                                    <div className="mb-4">
                                                        <h3 className="text-xs font-semibold text-orange-600 uppercase tracking-wider mb-2">
                                                            Inbox ({suggestedTopics.length})
                                                        </h3>
                                                        <div className="space-y-1">
                                                            {suggestedTopics.map(topic => (
                                                                <div
                                                                    key={topic.id}
                                                                    onClick={() => setSelectedTopicId(topic.id)}
                                                                    className={`p-3 rounded-lg cursor-pointer border transition-colors ${selectedTopicId === topic.id
                                                                        ? 'bg-orange-50 border-orange-200'
                                                                        : 'bg-white border-gray-200 hover:bg-gray-50'
                                                                        }`}
                                                                >
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        <span className="px-1.5 py-0.5 bg-orange-100 text-orange-700 text-[10px] font-bold rounded uppercase">
                                                                            AI Draft
                                                                        </span>
                                                                        <span className="text-xs text-gray-500">
                                                                            {formatDate(topic.created_at)}
                                                                        </span>
                                                                    </div>
                                                                    <h4 className="font-medium text-gray-900 text-sm truncate">
                                                                        {topic.title}
                                                                    </h4>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => setSortBy('date')}
                                                        className={`px-3 py-1 text-sm rounded-md ${sortBy === 'date' ? 'bg-gray-200 text-gray-800' : 'text-gray-500 hover:bg-gray-100'
                                                            }`}
                                                    >
                                                        By Date
                                                    </button>
                                                    <button
                                                        onClick={() => setSortBy('name')}
                                                        className={`px-3 py-1 text-sm rounded-md ${sortBy === 'name' ? 'bg-gray-200 text-gray-800' : 'text-gray-500 hover:bg-gray-100'
                                                            }`}
                                                    >
                                                        By Name
                                                    </button>
                                                </div>
                                            </div>

                                            {showTopicForm && (
                                                <div className="p-4 border-b border-gray-200 bg-gray-50">
                                                    <TopicForm onSubmit={handleAddTopic} onCancel={() => setShowTopicForm(false)} />
                                                </div>
                                            )}

                                            <div className="divide-y divide-gray-100 max-h-[calc(100vh-280px)] overflow-y-auto">
                                                {activeTopics.length === 0 && suggestedTopics.length === 0 ? (
                                                    <div className="p-6 text-center text-gray-500">
                                                        <p>No topics yet.</p>
                                                        <p className="text-sm">Create one to get started!</p>
                                                    </div>
                                                ) : (
                                                    activeTopics.map(topic => (
                                                        <div
                                                            key={topic.id}
                                                            onClick={() => setSelectedTopicId(topic.id)}
                                                            className={`p-4 cursor-pointer transition-colors ${selectedTopicId === topic.id
                                                                ? 'bg-gray-100 border-l-4 border-gray-900'
                                                                : 'hover:bg-gray-50'
                                                                }`}
                                                        >
                                                            <div className="flex items-start justify-between gap-2">
                                                                <div className="flex-1 min-w-0">
                                                                    <h3 className="font-medium text-gray-900 truncate">{topic.title}</h3>
                                                                    <p className="text-sm text-gray-500 mt-1">{formatDate(topic.created_at)}</p>
                                                                    {topic.due_date && (
                                                                        <p className="text-xs text-orange-600 mt-1">
                                                                            Due: {new Date(topic.due_date).toLocaleDateString()}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                                <StatusBadge status={topic.status} />
                                                            </div>
                                                            <div className="mt-2 text-xs text-gray-400">
                                                                {(topic.contributions || []).length} contribution{(topic.contributions || []).length !== 1 ? 's' : ''}
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Right panel - Topic detail (Only show in list view or if selected in kanban overlay - simplified for now just list view logic) */}
                            {viewMode === 'list' && (
                                <div className="flex-1 min-w-0">
                                    {selectedTopic ? (
                                        <div className="space-y-6">
                                            <div className="bg-white rounded-xl border border-gray-200 p-6">
                                                {selectedTopic.status === 'suggested' && (
                                                    <div className="mb-6 p-4 bg-orange-50 border border-orange-100 rounded-lg flex items-center justify-between">
                                                        <div>
                                                            <h3 className="font-semibold text-orange-900">AI Suggested Topic</h3>
                                                            <p className="text-sm text-orange-700">
                                                                This topic was created from an inbound email. Review and approve it to start discussion.
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => handleDeleteTopic()}
                                                                className="px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors border border-transparent hover:border-red-200"
                                                            >
                                                                Reject
                                                            </button>
                                                            <button
                                                                onClick={() => handleApproveTopic(selectedTopicId)}
                                                                className="px-3 py-1.5 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-lg transition-colors shadow-sm"
                                                            >
                                                                Approve Topic
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="flex items-start justify-between">
                                                    <div>
                                                        <h2 className="text-2xl font-bold text-gray-900">{selectedTopic.title}</h2>
                                                        {selectedTopic.description && (
                                                            <p className="text-gray-600 mt-2">{selectedTopic.description}</p>
                                                        )}
                                                        <div className="flex items-center gap-4 mt-3 text-sm text-gray-500">
                                                            <span>Created: {formatDate(selectedTopic.created_at)}</span>
                                                            {selectedTopic.due_date && (
                                                                <span className="text-orange-600">
                                                                    Due: {new Date(selectedTopic.due_date).toLocaleDateString()}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <select
                                                            value={selectedTopic.status}
                                                            onChange={(e) => handleUpdateStatus(e.target.value)}
                                                            className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-gray-900"
                                                        >
                                                            <option value="open">Open</option>
                                                            <option value="pending">Pending</option>
                                                            <option value="decided">Decided</option>
                                                        </select>
                                                        <button
                                                            onClick={handleDeleteTopic}
                                                            className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                                                            title="Delete topic"
                                                        >
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <AISummary topic={selectedTopic} apiKey={apiKey} />

                                            <div className="bg-white rounded-xl border border-gray-200 p-6">
                                                <h3 className="font-semibold text-gray-800 mb-4">Add Your Input</h3>
                                                <ContributionForm onSubmit={handleAddContribution} />
                                            </div>

                                            <div className="space-y-4">
                                                <h3 className="font-semibold text-gray-800">
                                                    Discussion ({(selectedTopic.contributions || []).length})
                                                </h3>
                                                {(selectedTopic.contributions || []).length === 0 ? (
                                                    <div className="bg-gray-50 rounded-lg p-8 text-center text-gray-500">
                                                        <p>No contributions yet. Be the first to share your input!</p>
                                                    </div>
                                                ) : (
                                                    (selectedTopic.contributions || []).map(contribution => (
                                                        <Contribution
                                                            key={contribution.id}
                                                            contribution={contribution}
                                                            topicId={selectedTopic.id}
                                                        />
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl border border-gray-200 p-12 text-center">
                                            <TenexityLogo size={64} className="mx-auto mb-4 opacity-20" />
                                            <h2 className="text-xl font-semibold text-gray-800 mb-2">Select a Topic</h2>
                                            <p className="text-gray-500">Choose a topic from the list or create a new one to start collaborating.</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Modal for Topic Detail in Kanban View (reuse selectedTopic) */}
                            {viewMode === 'kanban' && selectedTopic && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                    <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
                                        <button
                                            onClick={() => setSelectedTopicId(null)}
                                            className="absolute top-4 right-4 p-2 text-gray-500 hover:bg-gray-100 rounded-full z-10"
                                        >
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                        </button>

                                        <div className="p-8 space-y-6">
                                            <div className="flex items-start justify-between">
                                                <div>
                                                    <h2 className="text-2xl font-bold text-gray-900">{selectedTopic.title}</h2>
                                                    {selectedTopic.description && (
                                                        <p className="text-gray-600 mt-2">{selectedTopic.description}</p>
                                                    )}
                                                    <div className="flex items-center gap-4 mt-3 text-sm text-gray-500">
                                                        <span>Created: {formatDate(selectedTopic.created_at)}</span>
                                                        {selectedTopic.due_date && (
                                                            <span className="text-orange-600">
                                                                Due: {new Date(selectedTopic.due_date).toLocaleDateString()}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <select
                                                        value={selectedTopic.status}
                                                        onChange={(e) => handleUpdateStatus(e.target.value)}
                                                        className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-gray-900"
                                                    >
                                                        <option value="suggested">Inbox</option>
                                                        <option value="open">Discussion</option>
                                                        <option value="pending">Pending</option>
                                                        <option value="decided">Decided</option>
                                                    </select>
                                                    <button
                                                        onClick={handleDeleteTopic}
                                                        className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                                                        title="Delete topic"
                                                    >
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>

                                            <AISummary topic={selectedTopic} apiKey={apiKey} />

                                            <div className="bg-white rounded-xl border border-gray-200 p-6">
                                                <h3 className="font-semibold text-gray-800 mb-4">Add Your Input</h3>
                                                <ContributionForm onSubmit={handleAddContribution} />
                                            </div>

                                            <div className="space-y-4">
                                                <h3 className="font-semibold text-gray-800">
                                                    Discussion ({(selectedTopic.contributions || []).length})
                                                </h3>
                                                {(selectedTopic.contributions || []).length === 0 ? (
                                                    <div className="bg-gray-50 rounded-lg p-8 text-center text-gray-500">
                                                        <p>No contributions yet. Be the first to share your input!</p>
                                                    </div>
                                                ) : (
                                                    (selectedTopic.contributions || []).map(contribution => (
                                                        <Contribution
                                                            key={contribution.id}
                                                            contribution={contribution}
                                                            topicId={selectedTopic.id}
                                                        />
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div >

                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        apiKey={apiKey}
                        setApiKey={setApiKey}
                    />
                    <InviteModal
                        isOpen={showInvite}
                        onClose={() => setShowInvite(false)}
                    />
                </div >
            );
        };

        // ============================================
        // APP ROOT
        // ============================================
        const App = () => {
            const { user, loading, boards, isSupabaseConfigured } = useContext(AuthContext);

            if (loading) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center">
                        <Spinner />
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen />;
            }

            if (boards.length === 0) {
                return <OnboardingScreen />;
            }

            return (
                <BoardProvider>
                    <Dashboard />
                </BoardProvider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <AuthProvider>
                <App />
            </AuthProvider>
        );
    </script>
</body>

</html>